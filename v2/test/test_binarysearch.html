<!DOCTYPE html>
<html>
  <head>
    <!-- requirejs config -->
    <script>
      var require = {
        baseUrl : '../', 
      };
    </script>
    <!-- requirejs -->
    <script type="text/javascript" src="../../lib/require.js"></script>
    <!--  main -->
    <script text="javascript">

      require(['util/binarysearch', 'util/interval'], function (BinarySearch, Interval) {


        var makeBatch = function (size, random, scale) {
          let batch = [];
          random = random || false;
          scale = scale || 1;
          for (let i=0; i<size; i++) {
            if (random) {
              low = Math.random()*scale;
            } else {
              low = i;
            }
            batch.push(low);
          }
          return batch;
        };

        var timeit = function (func, name) {
          let t0 = performance.now();
          let result = func();
          let t1 = performance.now();
          console.log(name, t1-t0);
          return result;
        };

        var binary1 = function (batch1, batch2) {
          let b = new BinarySearch();
          b.insert(batch1);
          timeit(function () {
            b.insert_searchsplice(batch2);
          }, "binarysearch insert " + batch1.length + " " + batch2.length);

        };

        var binary2 = function (batch1, batch2) {
          let b = new BinarySearch();
          b.insert(batch1)
          timeit(function () {
            b.insert_concatsort(batch2);
          }, "appendsort insert " + batch1.length + " " + batch2.length);
        };

        var binary3 = function (batch1, batch2) {
          let b = new BinarySearch();
          b.insert(batch1)
          timeit(function () {
            b.insert(batch2);
          }, "insert " + batch1.length + " " + batch2.length);
        };

        var timeitmakebatch = function (size) {
          let result;
          timeit(function () {
            result = makeBatch(size);
          }, "batch " + size);
          return result;
        };

        var test_batch_insert = function () {
          let DATASIZE = 50000;
          let BATCHSIZE = 100;

          let batch1 = timeitmakebatch(DATASIZE);
          binary1(batch1, makeBatch(BATCHSIZE, true, DATASIZE));
          
          let batch2 = timeitmakebatch(DATASIZE);
          binary2(batch2, makeBatch(BATCHSIZE, true, DATASIZE));
       
          let batch3 = timeitmakebatch(DATASIZE);
          binary3(batch3, makeBatch(BATCHSIZE, true, DATASIZE));
        };

        var test_lookup = function () {
          let b = new BinarySearch();
          let batch = [1, 1, 1, 1, 1, 2, 3, 4, 4, 4, 5, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7];
          b.insert(batch);
          console.log(batch);

          let test_intervals = [
            new Interval(4, 7, true, true),
            new Interval(4, 7, true, false),
            new Interval(4, 7, false, true),
            new Interval(4, 7, false, false)
          ];

          test_intervals.forEach(function(interval){
            console.log(interval);
            let it = b.lookup(interval);
            for (let p of it) {
              console.log(p);
            }
          });

        }

        var test_ge = function(b) {
          console.log("leftmost greater or equal to x")
          let a = [0.1, 1, 1.1, 6.9, 7, 7.1];
          a.forEach(function(num) {
            console.log("x: " + num + " -> " + b.geIndexOf(new Point(num)));
          });
        };

        var test_le = function(b) {
          console.log("rightmost less or equal to x")
          let a = [0.1, 1, 1.1, 6.9, 7, 7.1];
          a.forEach(function(num) {
            console.log("x: " + num + " -> " + b.leIndexOf(new Point(num)));
          });
        };

        var test_gt = function(b) {
          console.log("leftmost greater than x")
          let a = [0.1, 1, 1.1, 6.9, 7, 7.1];
          a.forEach(function(num) {
            console.log("x: " + num + " -> " + b.gtIndexOf(new Point(num)));
          });
        };

        var test_lt = function(b) {
          console.log("rightmost less than x")
          let a = [0.1, 1, 1.1, 6.9, 7, 7.1];
          a.forEach(function(num) {
            console.log("x: " + num + " -> " + b.ltIndexOf(new Point(num)));
          });
        };

        var Point = function (num) {
          this.num = num;
        };

        var getValue = function(point) {
          return point.num;
        };

        var test_duplicates = function () {
          
          console.log("test_duplicates");
          let b = new BinarySearch({getValue:getValue});
          let batch = [1, 1, 1, 1, 1, 2, 3, 4, 4, 4, 5, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7].reverse();

          let points = batch.map(function(num){
            return new Point(num);
          });

          b.insert(points);
          console.log(points);
          test_ge(b);
          test_le(b);
          test_gt(b);
          test_lt(b);
        };

        var test_objects = function() {

          let batch = [1, 1, 1, 1, 1, 2, 3, 4, 4, 4, 5, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7].reverse();
          let points = batch.map(function(num){
            return new Point(num);
          });

          console.log(points);

          let b = new BinarySearch({getValue:getValue});
          b.insert(points);
          for (let p of b.items()) {
            console.log(p);
          }

        };


        var run = function () {
          //test_batch_insert();
          //test_lookup();
          test_duplicates();
          //test_objects();
        };

        if (document.readyState === "complete") run();
        else window.onload = run;
      });
    </script>    
  </head>
  <body>
    <h1>Test Binary Search</h1>
  </body>
</html>