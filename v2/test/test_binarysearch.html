<!DOCTYPE html>
<html>
  <head>
    <!-- requirejs config -->
    <script>
      var require = {
        baseUrl : '../', 
      };
    </script>
    <!-- requirejs -->
    <script type="text/javascript" src="../../lib/require.js"></script>
    <!--  main -->
    <script text="javascript">

      require(['util/binarysearch', 'util/interval'], function (BinarySearch, Interval) {


        var makeBatch = function (size, random, scale) {
          let batch = [];
          random = random || false;
          scale = scale || 1;
          for (let i=0; i<size; i++) {
            if (random) {
              low = Math.random()*scale;
            } else {
              low = i;
            }
            batch.push(low);
          }
          return batch;
        };

        var timeit = function (func, name) {
          let t0 = performance.now();
          let result = func();
          let t1 = performance.now();
          console.log(name, t1-t0);
          return result;
        };

        var binary1 = function (batch1, batch2) {
          let b = new BinarySearch();
          b.insert(batch1);
          timeit(function () {
            b._insert_searchsplice(batch2);
          }, "binarysearch insert " + batch1.length + " " + batch2.length);

        };

        var binary2 = function (batch1, batch2) {
          let b = new BinarySearch();
          b.insert(batch1)
          timeit(function () {
            b._insert_concatsort(batch2);
          }, "appendsort insert " + batch1.length + " " + batch2.length);
        };

        var binary3 = function (batch1, batch2) {
          let b = new BinarySearch();
          b.insert(batch1)
          timeit(function () {
            b.insert(batch2);
          }, "insert " + batch1.length + " " + batch2.length);
        };

        var timeitmakebatch = function (size) {
          let result;
          timeit(function () {
            result = makeBatch(size);
          }, "batch " + size);
          return result;
        };

        var test_batch_insert = function () {
          let DATASIZE = 50000;
          let BATCHSIZE = 10;

          let batch1 = timeitmakebatch(DATASIZE);
          binary1(batch1, makeBatch(BATCHSIZE, true, DATASIZE));
          
          let batch2 = timeitmakebatch(DATASIZE);
          binary2(batch2, makeBatch(BATCHSIZE, true, DATASIZE));
       
          let batch3 = timeitmakebatch(DATASIZE);
          binary3(batch3, makeBatch(BATCHSIZE, true, DATASIZE));
        };

        var test_big_batch = function () {
          let DATASIZE = 500000;
          let BATCHSIZE = 500000;
          let batch3 = timeitmakebatch(DATASIZE);
          binary3(batch3, makeBatch(BATCHSIZE, true, DATASIZE));
        };



        var test_ge = function(b) {
          console.log("leftmost greater or equal to x")
          let a = [0.1, 1, 1.1, 6.9, 7, 7.1];
          a.forEach(function(num) {
            console.log("x: " + num + " -> " + b.geIndexOf(num));
          });
        };

        var test_le = function(b) {
          console.log("rightmost less or equal to x")
          let a = [0.1, 1, 1.1, 6.9, 7, 7.1];
          a.forEach(function(num) {
            console.log("x: " + num + " -> " + b.leIndexOf(num));
          });
        };

        var test_gt = function(b) {
          console.log("leftmost greater than x")
          let a = [0.1, 1, 1.1, 6.9, 7, 7.1];
          a.forEach(function(num) {
            console.log("x: " + num + " -> " + b.gtIndexOf(num));
          });
        };

        var test_lt = function(b) {
          console.log("rightmost less than x")
          let a = [0.1, 1, 1.1, 6.9, 7, 7.1];
          a.forEach(function(num) {
            console.log("x: " + num + " -> " + b.ltIndexOf(num));
          });
        };



        var test_lookup = function () {
          let b = new BinarySearch();
          let batch = [1, 1, 1, 1, 1, 2, 3, 4, 4, 4, 5, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7];
          b.insert(batch);
          console.log(batch);

          let test_intervals = [
            new Interval(4, 7, true, true),
            new Interval(4, 7, true, false),
            new Interval(4, 7, false, true),
            new Interval(4, 7, false, false)
          ];

          test_intervals.forEach(function(interval){
            console.log(interval);
            let it = b.lookup(interval);
            for (let p of it) {
              console.log(p);
            }
          });
        };



        var test_objects = function () {
          let b = new BinarySearch({value: "value"});
          let batch = [1, 1, 1, 1, 1, 2, 3, 4, 4, 4, 5, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7];
          let objs = batch.map(x => {return {value:x}});
          b.insert(objs);
          
          let test_intervals = [
            new Interval(4, 7, true, true),
            new Interval(4, 7, true, false),
            new Interval(4, 7, false, true),
            new Interval(4, 7, false, false)
          ];

          test_intervals.forEach(function(interval){
            console.log(interval);
            let it = b.lookup(interval);
            for (let p of it) {
              console.log(p);
            }
          });
          
        };

        var test_remove_object = function() {
          let b = new BinarySearch({value: "value"});
          let batch = [1, 1, 1, 1, 1, 2, 3, 4, 4, 4, 5, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7];
          let objs = batch.map(x => {return {value:x}});
          b.insert(objs);
          console.log(b.array);

          let obj0 = b.array[0];
          let obj1 = b.array[3];
          let obj2 = b.array[6];

          console.log(0, b.indexOf(obj0));
          console.log(3, b.indexOf(obj1));
          console.log(6, b.indexOf(obj2));
          
          let obj = b.remove([obj2])[0];
          console.log(obj, obj2);
          console.log(obj === obj2);
          console.log(obj === obj0);
          console.log(b.array.indexOf(obj));
          console.log(b.array);

          // remove all
          b.remove(b.array);
          console.log(b.array);

          
        };


        var test_remove = function () {
          let DATASIZE = 50000;
          
          let batch = makeBatch(DATASIZE);
          let b = new BinarySearch();
          b.insert(batch);
          timeit(function () {
            b.remove(batch);
          }, "remove all");
          console.log(b.array);
        };

        var run = function () {
          //test_batch_insert();
          //test_lookup();
          //test_objects();
          //test_big_batch();
          test_remove_object();
        
          //test_remove();
        };

        if (document.readyState === "complete") run();
        else window.onload = run;
      });
    </script>    
  </head>
  <body>
    <h1>Test Binary Search</h1>
  </body>
</html>