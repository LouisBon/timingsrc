/*
	Copyright 2015 Norut Northern Research Institute
	Author : Ingar Mæhlum Arntzen

  This file is part of the Timingsrc module.

  Timingsrc is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Timingsrc is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with Timingsrc.  If not, see <http://www.gnu.org/licenses/>.
*/

/*
    Copyright 2015 Norut Northern Research Institute
    Author : Ingar Mæhlum Arntzen

  This file is part of the Timingsrc module.

  Timingsrc is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Timingsrc is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with Timingsrc.  If not, see <http://www.gnu.org/licenses/>.
*/

/*
  Copyright 2015 Norut Northern Research Institute
  Author : Njaal Trygve Borch njaal.borch@norut.no

  This file is part of the Timingsrc module.

  Timingsrc is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Timingsrc is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with Timingsrc.  If not, see <http://www.gnu.org/licenses/>.
*/

define("util/eventify",[],function(){"use strict";var e=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return function(n){n=n||e;var r="";for(var i=0;i<n;i++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}}(10);Array.prototype.concatAll=function(){var e=[];return this.forEach(function(t){e.push.apply(e,t)},this),e},Array.prototype.concatMap=function(e,t){return this.map(function(n){return e.call(t,n)}).concatAll()};var t=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.uber=t.prototype,e.prototype.constructor=e},n=function(){this._id=0,this._map={}};n.prototype._newID=function(){return this._id+=1,this._id},n.prototype._getID=function(e){var t,n=Object.keys(this._map).filter(function(n){return t=this._map[n],t.handler===e},this);return n.length>0?n[0]:-1},n.prototype.getItem=function(e){return this._map[e]},n.prototype.register=function(e,t){var n=this._getID(e);if(n>-1)throw new Error("handler already registered");return n=this._newID(),this._map[n]={ID:n,handler:e,ctx:t,count:0,pending:!1},n},n.prototype.unregister=function(e){var t=this._getID(e);t!==-1&&delete this._map[t]},n.prototype.getItems=function(){return Object.keys(this._map).map(function(e){return this.getItem(e)},this)};var r=function(t){return t._ID=e(4),t._callbacks={},t._immediateCallbacks=[],t._eBuffer=[],t._callbacks.events=new n,t._callbacks.events._options={init:!0},t},i=function(e){e.eventifyDefineEvent=function(e,t){if(e==="events")throw new Error("Illegal event type : 'events' is protected");t=t||{},t.init=t.init===undefined?!1:t.init,this._callbacks[e]=new n,this._callbacks[e]._options=t},e._eventifyMakeEItemList=function(e){var t=this.eventifyMakeInitEvents||function(e){return[]};return t.call(this,e).map(function(t){return{type:e,e:t}})},e._eventifyMakeInitEvents=function(e){if(e!=="events")return this._eventifyMakeEItemList(e);var t=Object.keys(this._callbacks).filter(function(e){return e!=="events"&&this._callbacks[e]._options.init===!0},this);return t.concatMap(function(e){return this._eventifyMakeEItemList(e)},this)},e._eventifyEventFormatter=function(e,t){var n=this.eventifyEventFormatter||function(e,t){return t};return e==="events"&&(t=t.map(function(e){return{type:e.type,e:n(e.type,e.e)}})),n(e,t)},e._eventifyCallbackFormatter=function(e,t,n){var r=this.eventifyCallbackFormatter||function(e,t,n){return[t]};return r.call(this,e,t,n)},e.eventifyTriggerEvents=function(e){e.forEach(function(e){if(e.type===undefined)throw new Error("Illegal event type; undefined");if(e.type==="events")throw new Error("Illegal event type; triggering of events on protocted event type 'events'")},this);if(e.length===0)return this;this._eBuffer.push.apply(this._eBuffer,e);if(this._eBuffer.length===e.length){var t=this;Promise.resolve().then(function(){t._eventifyTriggerProtectedEvents(t._eBuffer),t._eventifyTriggerRegularEvents(t._eBuffer),t._eBuffer=[],t._eventifyFlushImmediateCallbacks()})}return this},e.eventifyTriggerEvent=function(e,t){return this.eventifyTriggerEvents([{type:e,e:t}])},e._eventifyTriggerProtectedEvents=function(e,t){this._eventifyTriggerEvent("events",e,t)},e._eventifyTriggerRegularEvents=function(e,t){e.forEach(function(e){this._eventifyTriggerEvent(e.type,e.e,t)},this)},e._eventifyTriggerEvent=function(e,t,n){var r,t,i={};if(!this._callbacks.hasOwnProperty(e))throw new Error("Unsupported event type "+e);var s=this._callbacks[e],o=s._options.init;return s.getItems().forEach(function(s){if(n===undefined){if(s.pending)return!1}else{if(s.ID!==n)return!1;i.init=!0,s.pending=!1}o&&(i.init=s.ID===n?!0:!1),i.count=s.count,i.src=this,t=this._eventifyEventFormatter(e,t),r=this._eventifyCallbackFormatter(e,t,i);try{return s.handler.apply(s.ctx,r),s.count+=1,!0}catch(u){console.log("Error in "+e+": "+s.handler+" "+s.ctx+": ",u)}},this),!1},e.on=function(e,t,n){if(!t||typeof t!="function")throw new Error("Illegal handler");if(!this._callbacks.hasOwnProperty(e))throw new Error("Unsupported event type "+e);var r=this._callbacks[e];n=n||this;var i=r.register(t,n);if(r._options.init){var s=r.getItem(i);s.pending=!0;var o=this,u=function(){var t=o._eventifyMakeInitEvents(e);t.length>0?e==="events"?o._eventifyTriggerProtectedEvents(t,i):o._eventifyTriggerRegularEvents(t,i):s.pending=!1};this._immediateCallbacks.push(u),Promise.resolve().then(function(){o._eventifyFlushImmediateCallbacks()})}return this},e._eventifyFlushImmediateCallbacks=function(){if(this._eBuffer.length===0){var e=this._immediateCallbacks;this._immediateCallbacks=[],e.forEach(function(e){e()})}},e.off=function(e,t){if(this._callbacks[e]!==undefined){var n=this._callbacks[e];n.unregister(t)}return this}},s=function(){r(this)};i(s.prototype),s.inherit=t;var o=function(e,t){s.call(this),this._value=e?!0:!1,this.eventifyDefineEvent("change",t)};s.inherit(o,s),o.prototype.eventifyMakeInitEvents=function(e){return e==="change"?[this._value]:[]},Object.defineProperty(o.prototype,"value",{get:function(){return this._value},set:function(e){return this.set(e)}}),o.prototype.get=function(){return this._value},o.prototype.set=function(e){return e=e?!0:!1,e!==this._value?(this._value=e,this.eventifyTriggerEvent("change",e),!0):!1},o.prototype.toogle=function(){var e=!this._value;return this._value=e,this.eventifyTriggerEvent("change",e),!0};var u=function(e,t){s.call(this),this._value=e,this.eventifyDefineEvent("change",t)};return s.inherit(u,s),u.prototype.eventifyMakeInitEvents=function(e){return e==="change"?[this._value]:[]},Object.defineProperty(u.prototype,"value",{get:function(){return this._value},set:function(e){return this.set(e)}}),u.prototype.get=function(){return this._value},u.prototype.set=function(e){return e!==this._value?(this._value=e,this.eventifyTriggerEvent("change",e),!0):!1},{eventifyPrototype:i,eventifyInstance:r,BaseEventObject:s,EventVariable:u,EventBoolean:o}}),define("util/motionutils",[],function(){"use strict";var e=function(e,t){if(t===undefined)throw new Error("no ts provided for calculateVector");var n=t-e.timestamp;return{position:e.position+e.velocity*n+.5*e.acceleration*n*n,velocity:e.velocity+e.acceleration*n,acceleration:e.acceleration,timestamp:t}},t=Object.freeze({INIT:"init",INSIDE:"inside",OUTSIDE_LOW:"outsidelow",OUTSIDE_HIGH:"outsidehigh"}),n=function(e,n){var r=e.position,i=e.velocity,s=e.acceleration;if(r>n[1])return t.OUTSIDE_HIGH;if(r<n[0])return t.OUTSIDE_LOW;if(r===n[1]){if(i>0)return t.OUTSIDE_HIGH;if(i===0&&s>0)return t.OUTSIDE_HIGH}else if(r===n[0]){if(i<0)return t.OUTSIDE_LOW;if(i==0&&s<0)return t.OUTSIDE_HIGH}return t.INSIDE},r=function(e,r){var i=n(e,r);return i!==t.INSIDE&&(e.velocity=0,e.acceleration=0,i===t.OUTSIDE_HIGH?e.position=r[1]:e.position=r[0]),e},i=function(e,t){if(e>t)return 1;if(e===t)return 0;if(e<t)return-1},s=function(t,n){var r=e(t,n),s=i(r.velocity,0);return s===0&&(s=i(t.acceleration,0)),s},o=function(e,t,n,r){return Math.pow(t,2)-2*n*(e-r)>=0?!0:!1},u=function(e,t,n,r){if(n===0&&t===0)return e!=r?[]:[0];if(n===0)return[(r-e)/t];if(o(e,t,n,r)===!1)return[];var i=t*t-2*n*(e-r);if(i===0)return[-t/n];var s=Math.sqrt(Math.pow(t,2)-2*n*(e-r)),u=(-t+s)/n,a=(-t-s)/n;return[Math.min(u,a),Math.max(u,a)]},a=function(e,t,n,r){var i=u(e,t,n,r);return i.length===0?[]:i.length==1?i[0]>0?[i[0]]:[]:i.length==2?i[1]<0?[]:i[0]>0?[i[0],i[1]]:i[1]>0?[i[1]]:[]:[]},f=function(e,t){var n=e.position,r=e.velocity,i=e.acceleration,s=a(n,r,i,t);return s.length===0?null:s[0]},l=function(e,t){var n=f(e,t[0]),r=f(e,t[1]);return n!==null&&r!==null?n<r?[n,t[0]]:[r,t[1]]:n!==null?[n,t[0]]:r!==null?[r,t[1]]:[null,null]},c=function(e,t){return e[0]-t[0]},h=function(e,t,n){var r=[],i=e.position,s=e.velocity,o=e.acceleration;for(var a=0;a<n.length;a++){var f=n[a],l=u(i,s,o,f.point);for(var h=0;h<l.length;h++){var p=l[h];0<=p&&p<=t&&r.push([p,f])}}return r.sort(c),r},p=function(e,t){var n=e.position,r=e.velocity,i=e.acceleration,s=n+r*t+.5*i*t*t;if(i!==0){var o=-r/i;if(0<=o&&o<=d){var u=n-.5*r*r/i;return i>0?[u,Math.max(n,s)]:[Math.min(n,s),u]}}return[Math.min(n,s),Math.max(n,s)]};return{calculateVector:e,calculateDirection:s,calculateMinPositiveRealSolution:f,calculateDelta:l,calculateInterval:p,calculateSolutionsInInterval:h,getCorrectRangeState:n,checkRange:r,RangeState:t}}),define("timingobject/timingbase",["util/eventify","util/motionutils"],function(e,t){"use strict";var n=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.uber=t.prototype,e.prototype.constructor=e},r=function(t){this._version=3,this._options=t||{},this._options.hasOwnProperty("timeout")||(this._options.timeout=!1),this._vector=null,this._range=null,this._timeout=null,this._tid=null,this._ready=!1,e.eventifyInstance(this),this.eventifyDefineEvent("ready",{init:!0}),this.eventifyDefineEvent("change",{init:!0}),this.eventifyDefineEvent("timeupdate",{init:!0})};e.eventifyPrototype(r.prototype),Object.defineProperty(r.prototype,"version",{get:function(){return this._version}}),Object.defineProperty(r.prototype,"range",{get:function(){return this._range===null?null:[this._range[0],this._range[1]]}}),Object.defineProperty(r.prototype,"vector",{get:function(){return this._vector===null?null:{position:this._vector.position,velocity:this._vector.velocity,acceleration:this._vector.acceleration,timestamp:this._vector.timestamp}}}),Object.defineProperty(r.prototype,"ready",{get:function(){return this._ready}}),Object.defineProperty(r.prototype,"readyPromise",{get:function(){var e=this;return new Promise(function(t,n){if(e._ready)t();else{var r=function(){e.off("ready",r),t()};e.on("ready",r)}})}}),Object.defineProperty(r.prototype,"pos",{get:function(){return this.query().position}}),Object.defineProperty(r.prototype,"vel",{get:function(){return this.query().velocity}}),Object.defineProperty(r.prototype,"acc",{get:function(){return this.query().acceleration}}),r.prototype.eventifyMakeInitEvents=function(e){return e==="change"?this._ready?[undefined]:[]:e==="timeupdate"?this._ready?[undefined]:[]:e==="ready"?this._ready?[undefined]:[]:[]},r.prototype.query=function(){return this.vector===null?null:t.calculateVector(this.vector,this.clock.now())},r.prototype.update=function(e){},r.prototype._getRange=function(){return null},r.prototype._preProcess=function(e){this._range===null&&(this._range=this._getRange());var e=this._onChange(e);this._process(e)},r.prototype._onChange=function(e){return e},r.prototype._renewTimeout=function(){if(this._options.timeout===!0){this._clearTimeout();var e=this._calculateTimeoutVector();if(e===null)return;var t=this.clock.now(),n=e.timestamp-t,r=this;this._timeout=this.clock.setTimeout(function(){r._process(r._onTimeout(e))},n,{anchor:t,early:.005})}},r.prototype._calculateTimeoutVector=function(){return null},r.prototype._clearTimeout=function(){this._timeout!==null&&(this._timeout.cancel(),this._timeout=null)},r.prototype._onTimeout=function(e){return e},r.prototype._process=function(e){if(e!==null){var t=this._vector;this._vector=e,t===null&&(this._ready=!0,this.eventifyTriggerEvent("ready")),this._postProcess(this.vector)}this._renewTimeout()},r.prototype._postProcess=function(e){this.eventifyTriggerEvent("change"),this.eventifyTriggerEvent("timeupdate");var t=e.velocity!==0||e.acceleration!==0;if(t&&this._tid===null){var n=this;this._tid=setInterval(function(){n.eventifyTriggerEvent("timeupdate")},200)}else!t&&this._tid!==null&&(clearTimeout(this._tid),this._tid=null)};var i=function(e,t){r.call(this,t),this._timingsrc=null;var n=this;this._internalOnChange=function(){var e=n.timingsrc.vector;n._preProcess(e)},this.timingsrc=e};return n(i,r),Object.defineProperty(i.prototype,"clock",{get:function(){return this.timingsrc.clock}}),Object.defineProperty(i.prototype,"timingsrc",{get:function(){return this._timingsrc},set:function(e){this._timingsrc&&this._timingsrc.off("change",this._internalOnChange,this),this._range=null,this._vector=null,this._clearTimeout(),clearTimeout(this._tid),this._timingsrc=e,this._timingsrc.on("change",this._internalOnChange,this)}}),i.prototype.update=function(e){return this.timingsrc.update(e)},i.prototype._getRange=function(){return this.timingsrc.range},{TimingBase:r,ConverterBase:i,inherit:n,motionutils:t}}),define("timingobject/skewconverter",["./timingbase"],function(e){"use strict";var t=e.ConverterBase,n=e.inherit,r=function(e,n){this._skew=n,t.call(this,e)};return n(r,t),r.prototype._getRange=function(){var e=this.timingsrc.range;return e[0]=e[0]===-Infinity?e[0]:e[0]+this._skew,e[1]=e[1]===Infinity?e[1]:e[1]+this._skew,e},r.prototype._onChange=function(e){return e.position+=this._skew,e},r.prototype.update=function(e){return e.position!==undefined&&e.position!==null&&(e.position=e.position-this._skew),this.timingsrc.update(e)},Object.defineProperty(r.prototype,"skew",{get:function(){return this._skew}}),r.prototype.setSkew=function(e){this._skew=e;var t=this.timingsrc.vector;this._preProcess(t)},r}),define("timingobject/delayconverter",["./timingbase"],function(e){"use strict";var t=e.ConverterBase,n=e.inherit,r=function(e,n){if(n<0)throw new Error("negative delay not supported");if(n===0)throw new Error("zero delay makes delayconverter pointless");t.call(this,e),this._delay=n};return n(r,t),r.prototype._onChange=function(e){var t=this.clock.now()-e.timestamp;e.timestamp+=this._delay;if(t<this._delay){var n=this,r=(this._delay-t)*1e3;return setTimeout(function(){n._process(e)},r),null}return e},r.prototype.update=function(e){throw new Error("update is not legal on delayed (non-live) timingobject")},r}),define("timingobject/scaleconverter",["./timingbase"],function(e){"use strict";var t=e.ConverterBase,n=e.inherit,r=function(e,n){this._factor=n,t.call(this,e)};return n(r,t),r.prototype._getRange=function(){var e=this.timingsrc.range;return[e[0]*this._factor,e[1]*this._factor]},r.prototype._onChange=function(e){return e.position=e.position*this._factor,e.velocity=e.velocity*this._factor,e.acceleration=e.acceleration*this._factor,e},r.prototype.update=function(e){return e.position!==undefined&&e.position!==null&&(e.position=e.position/this._factor),e.velocity!==undefined&&e.velocity!==null&&(e.velocity=e.velocity/this._factor),e.acceleration!==undefined&&e.acceleration!==null&&(e.acceleration=e.acceleration/this._factor),this.timingsrc.update(e)},r}),define("timingobject/loopconverter",["./timingbase"],function(e){"use strict";var t=e.motionutils,n=e.ConverterBase,r=e.inherit,i=function(e,t){this.skew=e,this.length=t};i.mod=function(e,t){return(e%t+t)%t},i.prototype.getPoint=function(e){return{n:Math.floor((e-this.skew)/this.length),offset:i.mod(e-this.skew,this.length)}},i.prototype.getFloat=function(e){return this.skew+e.n*this.length+e.offset},i.prototype.transformFloat=function(e,t){t=t===undefined?this.skew:t;var n=this.getPoint(e),r=this.getPoint(t);return this.getFloat({n:r.n,offset:n.offset})};var s=function(e,t){n.call(this,e,{timeout:!0}),this._range=t,this._coords=new i(t[0],t[1]-t[0])};return r(s,n),s.prototype._transform=function(e){return this._coords.transformFloat(e)},s.prototype._inverse=function(e){var t=this.query().position,n=this.timingsrc.query().position,r=e-t,i=r+n;return i},s.prototype.query=function(){if(this.vector===null)return{position:undefined,velocity:undefined,acceleration:undefined};var e=t.calculateVector(this.vector,this.clock.now());if(e.position>this._range[1])this._process(this._calculateInitialVector());else{if(!(e.position<this._range[0]))return e;this._process(this._calculateInitialVector())}return t.calculateVector(this.vector,this.clock.now())},s.prototype.update=function(e){return e.position!==undefined&&e.position!==null&&(e.position=this._inverse(e.position)),this.timingsrc.update(e)},s.prototype._calculateTimeoutVector=function(){var e=this.query(),n=t.calculateDelta(e,this.range),r=n[0];if(r===null)return null;var i=n[1],s=t.calculateVector(e,e.timestamp+r);return s.position=i,s},s.prototype._onTimeout=function(e){return this._calculateInitialVector()},s.prototype._onChange=function(e){return this._calculateInitialVector()},s.prototype._calculateInitialVector=function(){var e=this.timingsrc.query(),t=this._transform(e.position);return{position:t,velocity:e.velocity,acceleration:e.acceleration,timestamp:e.timestamp}},s}),define("timingobject/rangeconverter",["./timingbase"],function(e){"use strict";var t=e.motionutils,n=e.ConverterBase,r=t.RangeState,i=e.inherit,s=function(){var e=r.INIT,t=function(e,t){return e===r.OUTSIDE_HIGH&&t===r.OUTSIDE_LOW?!1:e===r.OUTSIDE_LOW&&t===r.OUTSIDE_HIGH?!1:e===r.INIT?!1:!0},n=function(){return e},i=function(n){if(n===r.INSIDE||n===r.OUTSIDE_LOW||n===r.OUTSIDE_HIGH)if(n!==e){var i=e;return e=n,{real:t(i,n),abs:!0}}return{real:!1,abs:!1}};return{get:n,set:i}},o=function(e,t){n.call(this,e,{timeout:!0}),this._state=s(),this._range=t};return i(o,n),o.prototype.query=function(){if(this.vector===null)return{position:undefined,velocity:undefined,acceleration:undefined};var e=t.calculateVector(this.timingsrc.vector,this.clock.now()),n=t.getCorrectRangeState(e,this._range);return n!==r.INSIDE&&this._preProcess(e),t.calculateVector(this.vector,this.clock.now())},o.prototype._calculateTimeoutVector=function(){var e=this.timingsrc.query(),n=t.calculateDelta(e,this.range),r=n[0];if(r===null)return null;var i=n[1],s=t.calculateVector(e,e.timestamp+r);return s.position=i,s},o.prototype._onTimeout=function(e){return this._onChange(e)},o.prototype._onChange=function(e){var n=t.getCorrectRangeState(e,this._range),i=this._state.set(n);if(i.real)this._state.get()!==r.INSIDE&&(e=t.checkRange(e,this._range));else if(this._state.get()!==r.INSIDE){if(!i.abs)return null;e=t.checkRange(e,this._range)}return e},o}),define("timingobject/timeshiftconverter",["./timingbase","./rangeconverter"],function(e,t){"use strict";var n=e.motionutils,r=e.ConverterBase,i=e.inherit,s=function(e,t){r.call(this,e),this._timeOffset=t};i(s,r),s.prototype._onChange=function(e){var t=n.calculateVector(e,e.timestamp+this._timeOffset);return t.timestamp=e.timestamp,t};var o=function(e,n,r){return r=r||e.range,new t(new s(e,n),r)};return o}),define("timingobject/localconverter",["./timingbase"],function(e){"use strict";var t=e.ConverterBase,n=e.inherit,r=function(e){t.call(this,e),this._speculative=!1};return n(r,t),r.prototype.update=function(e){var t=this.timingsrc.update(e);this._speculative=!0;var n=this;return Promise.resolve().then(function(){n._preProcess(t)}),t},r.prototype._onChange=function(e){return this._speculative&&(this._speculative=!1),e},r}),define("timingobject/derivativeconverter",["./timingbase"],function(e){"use strict";var t=e.ConverterBase,n=e.inherit,r=function(e,n){t.call(this,e)};return n(r,t),r.prototype._getRange=function(){return[-Infinity,Infinity]},r.prototype._onChange=function(e){var t={position:e.velocity,velocity:e.acceleration,acceleration:0,timestamp:e.timestamp};return t},r.prototype.update=function(e){throw new Error("updates illegal on derivative of timingobject")},r}),define("timingobject/timingprovider",["util/motionutils","util/eventify"],function(e,t){(function(){"performance"in window==0&&(window.performance={},window.performance.offset=(new Date).getTime()),"now"in window.performance==0&&(window.performance.now=function(){return(new Date).getTime()-window.performance.offset})})();var n={now:function(){return performance.now()/1e3}},r=Object.freeze({CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed"}),i=function(e){e=e||{},this._range=e.range||[-Infinity,Infinity],this._vector={position:0,velocity:0,acceleration:0,timestamp:n.now()},this._skew=0,this._readyState=r.OPEN,t.eventifyInstance(this),this.eventifyDefineEvent("vectorchange",{init:!1}),this.eventifyDefineEvent("skewchange",{init:!1}),this.eventifyDefineEvent("readystatechange",{init:!1}),e.vector&&this.update(e.vector)};return t.eventifyPrototype(i.prototype),i.prototype._setSkew=function(e){this._skew=e,this.eventifyTriggerEvent("skewchange")},i.prototype._setVector=function(e){this._vector=e,this.eventifyTriggerEvent("vectorchange")},i.prototype.update=function(t){if(!this._clock===null)throw new Error("timing provider not ready to accept update");if(t===undefined||t===null)throw new Error("drop update, illegal updatevector");var r=t.position===undefined||t.position===null?undefined:t.position,i=t.velocity===undefined||t.velocity===null?undefined:t.velocity,s=t.acceleration===undefined||t.acceleration===null?undefined:t.acceleration;if(r===undefined&&i===undefined&&s===undefined)throw new Error("drop update, noop");var o=t.timestamp||n.now(),u=e.calculateVector(this._vector,o);u=e.checkRange(u,this._range);var a=u.position,f=u.velocity,l=u.acceleration;r=r!==undefined?r:a,i=i!==undefined?i:f,s=s!==undefined?s:l;var c={position:r,velocity:i,acceleration:s,timestamp:o},h=this;return Promise.resolve().then(function(){h._setVector(c)}),c},Object.defineProperty(i.prototype,"range",{get:function(){return[this._range[0],this._range[1]]}}),Object.defineProperty(i.prototype,"skew",{get:function(){return this._skew}}),Object.defineProperty(i.prototype,"vector",{get:function(){return this._vector}}),Object.defineProperty(i.prototype,"readyState",{get:function(){return this._readyState}}),{LocalTimingProvider:i,TimingProviderState:r}}),define("util/timeoututils",[],function(){"use strict";var e=function(e,t,n,r){this._clock=e;var i=this._clock.now();this._tid=null,this._callback=t,this._delay_counter=0,this._options=r||{},this._options.anchor=this._options.anchor||i,this._options.early=Math.abs(this._options.early)||0,this._target=this._options.anchor+n;var s=this;window.addEventListener("message",this,!0);var o=this._target-this._clock.now();o>10?this._tid=setTimeout(function(){s._ontimeout()},o-3e3):this._tid=setTimeout(function(){s._ontimeout()},(o-s._options.early)*1e3)};return Object.defineProperty(e.prototype,"target",{get:function(){return this._target}}),e.prototype._ontimeout=function(){if(this._tid!==null){var e=this._target-this._clock.now();if(e<=0)this.cancel(),this._callback();else if(e>this._options.early){var t=this;this._tid=setTimeout(function(){t._ontimeout()},(e-this._options.early)*1e3)}else this._smalldelay()}},e.prototype.handleEvent=function(e){if(e.source===window&&e.data.indexOf("smalldelaymsg_")===0){e.stopPropagation();var t=parseInt(e.data.split("_")[1]);this._tid!==null&&this._tid===t&&this._ontimeout()}},e.prototype._smalldelay=function(){this._delay_counter++;var e=this;window.postMessage("smalldelaymsg_"+e._tid,"*")},e.prototype.cancel=function(){if(this._tid!==null){clearTimeout(this._tid),this._tid=null;var e=this;window.removeEventListener("message",this,!0)}},{setTimeout:function(t,n,r,i){return new e(t,n,r,i)}}}),define("util/masterclock",["./eventify","./timeoututils"],function(e,t){"use strict";(function(){"performance"in window==0&&(window.performance={},window.performance.offset=(new Date).getTime()),"now"in window.performance==0&&(window.performance.now=function(){return(new Date).getTime()-window.performance.offset})})();var n={now:function(){return performance.now()/1e3}},r=function(e,t){t===undefined&&(t=n.now());var r=t-e.timestamp;return{position:e.position+e.velocity*r,velocity:e.velocity,timestamp:t}},i=function(t){var r=n.now();t=t||{},this._vector={position:r,velocity:1,timestamp:r},e.eventifyInstance(this),this.eventifyDefineEvent("change"),this.adjust(t)};return e.eventifyPrototype(i.prototype),i.prototype.adjust=function(e){e=e||{};var t=n.now(),r=this.query(t);if(e.skew===undefined&&e.rate===undefined)return;this._vector={position:e.skew!==undefined?t+e.skew:r.position,velocity:e.rate!==undefined?e.rate:r.velocity,timestamp:r.timestamp},this.eventifyTriggerEvent("change")},i.prototype.now=function(){return r(this._vector,n.now()).position},i.prototype.query=function(e){return r(this._vector,e)},i.prototype.setTimeout=function(e,n,r){return t.setTimeout(this,e,n,r)},i}),define("timingobject/timingobject",["./timingbase","./timingprovider","util/masterclock"],function(e,t,n){"use strict";var r=e.motionutils,i=e.TimingBase,s=e.inherit,o=t.LocalTimingProvider,u=t.TimingProviderState,a=function(e){e=e||{},i.call(this,{timeout:!0}),this._clock=null,this._range=null,this._vector=null;var t=this;this._provider=e.provider||new o(e),this._onSkewChangeWrapper=function(){t._onSkewChange()},this._onVectorChangeWrapper=function(){t._onVectorChange()},this._onReadystateChangeWrapper=function(){t._onReadystateChange()},this._provider.on("readystatechange",this._onReadystateChangeWrapper,this),this._initialise()};return s(a,i),a.prototype._initialise=function(){if(this._provider.readyState!==u.OPEN)return;this._clock===null&&(this._range=this._provider.range,this._clock=new n({skew:this._provider.skew}),this._preProcess(this._provider.vector),this._provider.on("vectorchange",this._onVectorChangeWrapper,this),this._provider.on("skewchange",this._onSkewChangeWrapper,this))},a.prototype._onReadystateChange=function(){this._initialise()},a.prototype._onSkewChange=function(){this._clock.adjust({skew:this._provider.skew})},a.prototype._onVectorChange=function(){this._preProcess(this._provider.vector)},Object.defineProperty(a.prototype,"clock",{get:function(){return this._clock}}),Object.defineProperty(a.prototype,"provider",{get:function(){return this._provider}}),a.prototype.query=function(){if(this.vector===null)return{position:undefined,velocity:undefined,acceleration:undefined};var e=r.calculateVector(this.vector,this.clock.now()),t=r.getCorrectRangeState(e,this._range);return t!==r.RangeState.INSIDE&&this._preProcess(e),r.calculateVector(this.vector,this.clock.now())},a.prototype.update=function(e){return this._provider.update(e)},a.prototype._onChange=function(e){return r.checkRange(e,this._range)},a.prototype._calculateTimeoutVector=function(){var e=this.query(),t=r.calculateDelta(e,this.range),n=t[0];if(n===null)return null;if(n===Infinity)return null;var i=t[1],s=r.calculateVector(e,e.timestamp+n);return s.position=i,s},a.prototype._onTimeout=function(e){return r.checkRange(e,this._range)},a}),define("timingobject/main",["./timingbase","./skewconverter","./delayconverter","./scaleconverter","./loopconverter","./rangeconverter","./timeshiftconverter","./localconverter","./derivativeconverter","./timingobject","./timingprovider"],function(e,t,n,r,i,s,o,u,a,f,l){"use strict";return{inherit:e.inherit,ConverterBase:e.ConverterBase,SkewConverter:t,DelayConverter:n,ScaleConverter:r,LoopConverter:i,RangeConverter:s,TimeShiftConverter:o,LocalConverter:u,DerivativeConverter:a,TimingObject:f,TimingProviderState:l.TimingProviderState}}),define("util/interval",[],function(){"use strict";var e=function(e){var t=parseFloat(e);return e===t&&!isNaN(t)},t=function(e){this.name="IntervalError",this.message=e||""};t.prototype=Error.prototype;var n=function(n,r,i,s){var o=e(n),u=e(r);o&&r===undefined&&(r=n);if(!e(n))throw new t("low not a number");if(!e(r))throw new t("high not a number");if(n>r)throw new t("low > high");n===r&&(i=!0,s=!0),n===-Infinity&&(i=!0),r===Infinity&&(s=!0),i===undefined&&(i=!0),s===undefined&&(s=!1);if(typeof i!="boolean")throw new t("lowInclude not boolean");if(typeof s!="boolean")throw new t("highInclude not boolean");this.low=n,this.high=r,this.lowInclude=i,this.highInclude=s,this.length=this.high-this.low,this.singular=this.low===this.high,this.finite=isFinite(this.low)&&isFinite(this.high)};return n.prototype.toString=function(){var e=this.lowInclude?"[":"<",t=this.highInclude?"]":">",n=this.low===-Infinity?"<--":this.low.toFixed(2),r=this.high===Infinity?"-->":this.high.toFixed(2);return this.singular?e+n+t:e+n+","+r+t},n.prototype.coversPoint=function(e){return this.low<e&&e<this.high?!0:this.lowInclude&&e===this.low?!0:this.highInclude&&e===this.high?!0:!1},n.prototype.overlapsInterval=function(e){if(e instanceof n==0)throw new t("paramenter not instance of Interval");return this.singular&&e.singular?this.low===e.low:this.singular?e.coversPoint(this.low):e.singular?this.coversPoint(e.low):this.high<e.low?!1:this.high===e.low?this.coversPoint(e.low)&&e.coversPoint(this.high):this.low>e.high?!1:this.low===e.high?this.coversPoint(e.high)&&e.coversPoint(this.low):!0},n.prototype.coversInterval=function(e){if(e instanceof n==0)throw new t("paramenter not instance of Interval");return e.low<this.low||this.high<e.high?!1:this.low<e.low&&e.high<this.high?!0:this.low===e.low&&this.lowInclude===!1&&e.lowInclude===!0?!1:this.high===e.high&&this.highInclude===!1&&e.highInclude===!0?!1:!0},n.prototype.equals=function(e){return this.low!==e.low?!1:this.high!==e.high?!1:this.lowInclude!==e.lowInclude?!1:this.highInclude!==e.highInclude?!1:!0},n}),define("sequencing/sortedarraybinary",["util/interval"],function(e){"use strict";var t=function(e){var t=parseFloat(e);return e==t&&!isNaN(t)},n=function(e){this.name="SortedArrayError",this.message=e||""};n.prototype=Error.prototype;var r=function(){this.array=[]};return r.prototype.binaryIndexOf=function(e){var t=0,n=this.array.length-1,r,i;while(t<=n){r=(t+n)/2|0,i=this.array[r];if(i<e)t=r+1;else{if(!(i>e))return r;n=r-1}}return~n},r.prototype.insert=function(e){var t=this.binaryIndexOf(e);(t<0||t===0&&this.array[0]!==e)&&this.array.splice(Math.abs(t),0,e)},r.prototype.indexOf=function(e){var t=this.binaryIndexOf(e);return t<0||t===0&&this.array[0]!==e?-1:t},r.prototype.hasElement=function(e){var t=this.binaryIndexOf(e);return t<0||t===0&&this.array[0]!==e?!1:!0},r.prototype.remove=function(e){var t=this.binaryIndexOf(e);if(t<0||t===0&&this.array[0]!==e)return;this.array.splice(t,1)},r.prototype.getMinimum=function(){return this.array.length>0?this.array[0]:null},r.prototype.getMaximum=function(){return this.array.length>0?this.array[this.array.length-1]:null},r.prototype.ltIndexOf=function(e){var t=this.binaryIndexOf(e);return t=t<0?Math.abs(t)-1:t-1,t>=0?t:-1},r.prototype.leIndexOf=function(e){var t=this.binaryIndexOf(e);return t>0||t===0&&this.array[0]===e?t:(t=Math.abs(t)-1,t>=0?t:-1)},r.prototype.gtIndexOf=function(e){var t=this.binaryIndexOf(e);return t===0?this.array[0]===e&&(t=1):t=t<0?Math.abs(t):t+1,t<this.array.length?t:-1},r.prototype.geIndexOf=function(e){var t=this.binaryIndexOf(e);return t>0||t===0&&this.array[0]===e?t:(t=Math.abs(t),t<this.array.length?t:-1)},r.prototype.indexOf=function(e){var t=this.binaryIndexOf(e);return t<0||t===0&&this.array[0]!==e?-1:t},r.prototype.lookup=function(t){t===undefined&&(t=new e(-Infinity,Infinity,!0,!0));if(t instanceof e==0)throw new n("lookup requires Interval argument");var r=-1,i=-1;return t.lowInclude?r=this.geIndexOf(t.low):r=this.gtIndexOf(t.low),r===-1?[]:(t.highInclude?i=this.leIndexOf(t.high):i=this.ltIndexOf(t.high),i===-1?[]:this.array.slice(r,i+1))},r.prototype.get=function(e){return this.array[e]},r.prototype.list=function(){return this.array},r}),define("sequencing/multimap",[],function(){"use strict";var e=function(){this._map={}};return e.prototype.insert=function(e,t){return this.insertAll([{key:e,value:t}])},e.prototype.insertAll=function(e){var t,n=[];return e.forEach(function(e){this._map.hasOwnProperty(e.key)||(this._map[e.key]=[]),t=this._map[e.key],t.indexOf(e.value)===-1&&(t.push(e.value),n.push(e))},this),n},e.prototype.remove=function(e,t){return this.removeAll([{key:e,value:t}])},e.prototype.removeAll=function(e){var t,n,r=[];return e.forEach(function(e){this._map.hasOwnProperty(e.key)&&(n=this._map[e.key],t=n.indexOf(e.value),t>-1&&(n.splice(t,1),r.push(e),n.length===0&&delete this._map[e.key]))},this),r},e.prototype.hasKey=function(e){return this._map.hasOwnProperty(e)},e.prototype.keys=function(){return Object.keys(this._map)},e.prototype.getItemsByKey=function(e){var t=[];return this.hasKey(e)&&this._map[e].forEach(function(n){t.push({key:e,value:n})}),t},e.prototype.getItemsByKeys=function(e){e===undefined&&(e=this.keys());var t=[];return e.forEach(function(e){t=t.concat(this.getItemsByKey(e))},this),t},e.prototype.list=e.prototype.getItemsByKeys,e}),define("sequencing/axis",["util/interval","./sortedarraybinary","./multimap","util/eventify"],function(e,t,n,r){"use strict";var i=function(e){this.name="AxisError",this.message=e||""};i.prototype=Error.prototype;var s=Object.freeze({INIT:"init",NONE:"none",ADD:"add",UPDATE:"update",REPEAT:"repeat",REMOVE:"remove"}),o=Object.freeze({LOW:"low",SINGULAR:"singular",HIGH:"high",INSIDE:"inside",OUTSIDE:"outside",toInteger:function(e){if(e===o.LOW)return-1;if(e===o.HIGH)return 1;if(e===o.INSIDE)return 2;if(e===o.OUTSIDE)return 3;if(e===o.SINGULAR)return 0;throw new i("illegal string value for point type")},fromInteger:function(e){if(e===-1)return o.LOW;if(e===0)return o.SINGULAR;if(e===1)return o.HIGH;if(e===2)return o.INSIDE;if(e===3)return o.OUTSIDE;throw new i("illegal integer value for point type")}}),u=function(){this._map={},this._reverse=new n,this._index=new t,this._cache={},r.eventifyInstance(this),this.eventifyDefineEvent("change",{init:!1}),this._eBuffer=[]};return r.eventifyPrototype(u.prototype),u.prototype._remove=function(e){if(this._map.hasOwnProperty(e)){var t=this._map[e];delete this._map[e],this._reverse.remove(t.low,e),this._reverse.remove(t.high,e),this._reverse.hasKey(t.low)||this._index.remove(t.low),this._reverse.hasKey(t.high)||this._index.remove(t.high);var n;return this._cache.hasOwnProperty(e)&&(n=this._cache[e],delete this._cache[e]),{type:s.REMOVE,key:e,interval:t,data:n}}return{type:s.NONE,key:e,interval:undefined,data:undefined}},u.prototype._insert=function(e,t,n){var r={key:e,interval:t,data:n};return this._map.hasOwnProperty(e)?(r.old_interval=this._map[e],r.old_data=this._cache[e],this._remove(e),t.equals(r.old_interval)?r.type=s.REPEAT:r.type=s.UPDATE):r.type=s.ADD,this._map[e]=t,this._reverse.hasKey(t.low)||this._index.insert(t.low),this._reverse.hasKey(t.high)||this._index.insert(t.high),this._reverse.insert(t.low,e),this._reverse.insert(t.high,e),this._cache[e]=n,r},u.prototype.updateAll=function(t){var n,r=[],s,o,u;return t.forEach(function(t){s=t.key,o=t.interval,u=t.data;if(typeof s!="string")throw new i("key is "+typeof s+" - must be string");if(o===undefined)n=this._remove(s);else{if(o instanceof e==0)throw new i("parameter must be instanceof Interval");n=this._insert(s,o,u)}this.eventifyTriggerEvent("change",n),r.push(n)},this),r},u.prototype.update=function(e,t,n){return this.updateAll([{key:e,interval:t,data:n}])},u.prototype.lookupKeysByPoint=function(e){var t,n={};return e===undefined?Object.keys(this._map).forEach(function(e){n[e]=undefined}):Object.keys(this._map).forEach(function(r){t=this._map[r],t.coversPoint(e)&&(n[r]=undefined)},this),n},u.prototype.lookupKeysByInterval=function(e){var t={};return this._index.lookup(e).forEach(function(e){this._reverse.getItemsByKey(e).forEach(function(e){t[e.value]=undefined})},this),t},u.prototype.lookupByPoint=function(e){var t,n=[];return Object.keys(this._map).forEach(function(r){t=this._map[r],(e===undefined||t.coversPoint(e))&&n.push({key:r,interval:t,data:this._cache[r]})},this),n},u.prototype.lookupByInterval=function(e){var t=[],n,r;return this._index.lookup(e).forEach(function(n){this._reverse.getItemsByKey(n).forEach(function(r){n=r.key,e=this._map[r.value],t.push({key:r.value,interval:e,data:this._cache[r.value],point:n,pointType:this.getPointType(n,e)})},this)},this),t},u.prototype.items=function(){return this.lookupByPoint()},u.prototype.keys=function(){return Object.keys(this._map)},u.prototype.getItem=function(e){return this._map.hasOwnProperty(e)?{key:e,interval:this._map[e],data:this._cache[e]}:null},u.prototype.getInterval=function(e){return this._map.hasOwnProperty(e)?this._map[e]:null},u.prototype.getPointType=function(e,t){return t.singular&&e===t.low?o.SINGULAR:e===t.low?o.LOW:e===t.high?o.HIGH:t.low<e&&e<t.high?o.INSIDE:o.OUTSIDE},u.prototype.hasKey=function(e){return this._map.hasOwnProperty(e)},{Axis:u,OpType:s,PointType:o}}),define("sequencing/sequencer",["util/motionutils","util/eventify","util/interval","./axis"],function(e,t,n,r){"use strict";var i=function(e){return e.velocity!==0||e.acceleration!==0},s=Object.freeze({ENTER:"enter",EXIT:"exit",NONE:"none",toInteger:function(e){if(e===s.ENTER)return 1;if(e===s.EXIT)return-1;if(e===s.NONE)return 0;throw new f("illegal string value verb type "+e)},fromInteger:function(e){if(e===-1)return s.EXIT;if(e===1)return s.ENTER;if(e===0)return s.NONE;throw new f("illegal integer value for direction type "+e)}}),o=Object.freeze({BACKWARDS:"backwards",FORWARDS:"forwards",NODIRECTION:"nodirection",toInteger:function(e){if(e===o.BACKWARDS)return-1;if(e===o.FORWARDS)return 1;if(e===o.NODIRECTION)return 0;throw new f("illegal string value direction type "+string)},fromInteger:function(e){if(e===0)return o.NODIRECTION;if(e===-1)return o.BACKWARDS;if(e===1)return o.FORWARDS;throw new f("illegal integer value for direction type"+e+" "+typeof e)}}),u=r.OpType,a=function(e,t){this.queue=[],this.options=t||{},this.options.lookahead=this.options.lookahead||5,this.timeInterval=new n(e,e+this.options.lookahead,!0,!0),this.posInterval=null};a.prototype.getTimeInterval=function(){return this.timeInterval},a.prototype.getPosInterval=function(){return this.posInterval},a.prototype.setPosInterval=function(e){this.posInterval=e},a.prototype.sortFunc=function(e,t){return e.ts-t.ts},a.prototype.push=function(e,t,n){if(this.timeInterval.coversPoint(t)){var r={ts:t,task:n,push_ts:e};if(t>=e)return this.queue.push(r),this.queue.sort(this.sortFunc),!0}return!1},a.prototype.pop=function(e){var t=[];while(this.queue.length>0&&this.queue[0].ts<=e){var n=this.queue.shift(),r={task:n.task,pop_ts:e,push_ts:n.push_ts,ts:n.ts};t.push(r)}return t},a.prototype.invalidate=function(e){var t,n,r,i=[];for(t=0;t<this.queue.length;t++)r=this.queue[t],r.task.key===e&&i.push(r);for(t=0;t<i.length;t++)r=i[t],n=this.queue.indexOf(r),n>-1&&this.queue.splice(n,1)},a.prototype.advance=function(e){e<this.timeInterval.low,this.queue=[],this.timeInterval=new n(e,e+this.options.lookahead,!1,!0),this.posInterval=null},a.prototype.isExpired=function(e){return e>this.timeInterval.high},a.prototype.getDelayNextTs=function(e){return this.queue.length>0?Math.max(0,this.queue[0].ts-e):Math.max(0,this.timeInterval.high-e)},a.prototype.getNextTaskPoint=function(){return this.queue.length>0?this.queue[0].task.point:null};var f=function(e){this.name="SequencerError",this.message=e||""};f.prototype=Error.prototype;var l=function(e,t,n,r,i,u,a,f,l,c){var h=o.fromInteger(i),p=e._axis.getPointType(u,n);this.src=e,this.key=t,this.interval=n,this.data=r,this.point=u,this.pointType=p,this.dueTs=f,this.delay=a-f,this.directionType=h,this.type=c===s.EXIT?"remove":"change",this.op=l,this.enter=c===s.ENTER,this.exit=c===s.EXIT};l.prototype.toString=function(){var e="["+this.point.toFixed(2)+"]";e+=" "+this.key,e+=" "+this.interval.toString(),e+=" "+this.type;var t="none";return this.enter?t="enter":this.exit&&(t="exit"),e+=" ("+this.op+","+t+")",e+=" "+this.directionType,e+=" "+this.pointType,e+=" delay:"+this.delay.toFixed(4),this.data&&(e+=" "+JSON.stringify(this.data)),e};var c=function(e){this.key=e.key,this.interval=e.interval,this.data=e.data};c.prototype.toString=function(){var e=this.key+" "+this.interval.toString();return this.data&&(e+=" "+JSON.stringify(this.data)),e};var h=function(e,n){this._to=e,this._clock=e.clock,this._axis=n||new r.Axis,this._schedule=null,this._timeout=null,this._currentTimeoutPoint=null,this._activeKeys={},t.eventifyInstance(this),this.eventifyDefineEvent("change",{init:!0}),this.eventifyDefineEvent("remove"),this._wrappedOnTimingChange=function(){this._onTimingChange()},this._wrappedOnAxisChange=function(e){var t=e.map(function(e){return e.e});this._onAxisChange(t)},this._to.on("change",this._wrappedOnTimingChange,this)};return t.eventifyPrototype(h.prototype),Object.defineProperty(h.prototype,"Interval",{get:function(){return n}}),h.prototype.eventifyMakeInitEvents=function(e){return e==="change"?this._processInitialEvents():[]},h.prototype._isReady=function(){return this._schedule!==null},h.prototype._onTimingChange=function(t){var s=this._clock.now(),u=this._to.vector;this._isReady()===!1?(this._schedule=new a(s),this._axis.on("events",this._wrappedOnAxisChange,this)):(s=u.timestamp,this._schedule.advance(s));var f=e.calculateVector(u,s),l=this._axis.lookupKeysByPoint(f.position),c=Object.keys(this._activeKeys).filter(function(e){return!l.hasOwnProperty(e)}),h=Object.keys(l).filter(function(e){return!this._activeKeys.hasOwnProperty(e)},this),p=i(u);if(p){var d=f.position,v=this._axis.lookupByInterval(new n(d,d,!0,!0));v.forEach(function(t){if(t.pointType===r.PointType.SINGULAR)c.push(t.key);else{var n=t.interval,i=!1;t.pointType===r.PointType.LOW&&n.lowInclude?i=!0:t.pointType===r.PointType.HIGH&&n.highInclude&&(i=!0);var a=o.fromInteger(e.calculateDirection(u,s)),f=!0;t.pointType===r.PointType.LOW&&a===o.BACKWARDS&&(f=!1),t.pointType===r.PointType.HIGH&&a===o.FORWARDS&&(f=!1),!f&&i&&c.push(t.key),f&&!i&&h.push(t.key)}},this)}var m=c.map(function(e){return this._axis.getItem(e)},this),g=h.map(function(e){return this._axis.getItem(e)},this);this._processIntervalEvents(s,m,g,[]),this._load(s),this._main(s)},h.prototype.updateAll=function(e){this._axis.updateAll(e)},h.prototype._onAxisChange=function(t){var n=this;t=t.filter(function(e){return e.type!==u.NONE});var r=this._clock.now(),s=e.calculateVector(this._to.vector,r),o=s.position,a=[],f=[],l,c,h=t.filter(function(e){return e.type!==u.REPEAT}),p,d,v,m,g,y;h.forEach(function(e){m=e.interval,v=e.key,g=e.data,l=this.isActive(v),c=!1,(e.type===u.ADD||e.type===u.UPDATE)&&m.coversPoint(o)&&(c=!0),l&&!c?f.push({key:v,interval:m,data:g,opType:e.type}):!l&&c&&a.push({key:v,interval:m,data:g,opType:e.type})},this);var b=f.map(function(e){return e.key}),w=t.filter(function(e){return this.isActive(e.key)&&b.indexOf(e.key)===-1},this).map(function(e){return{key:e.key,interval:e.interval,data:e.data}},this);if(h.length===0){w.length>0&&Promise.resolve().then(function(){n._processIntervalEvents(r,[],[],w)});return}var E=i(s);if(!E){Promise.resolve().then(function(){n._processIntervalEvents(r,f,a,w)});return}if(!E)this._schedule.advance(r);else{h.forEach(function(e){this._schedule.invalidate(e.key)},this);var S,x=[];h.forEach(function(e){m=e.interval,v=e.key,g=e.data;if(e.type===u.REMOVE)return;if(E){var t={key:v,interval:m,data:g},n=this._schedule.getPosInterval();n!==null&&(n.coversPoint(m.low)&&(t.point=m.low),n.coversPoint(m.high)&&(t.point=m.high),t.pointType=this._axis.getPointType(t.point,t.interval),x.push(t))}},this),x.length>0&&this._load(r,x)}Promise.resolve().then(function(){n._processIntervalEvents(r,f,a,w),n._main(r)})},h.prototype._main=function(e){var t;e=e||this._clock.now(),t=this._processScheduleEvents(e,this._schedule.pop(e)),this.eventifyTriggerEvents(t);var n=i(this._to.vector);n&&this._schedule.isExpired(e)&&(e=this._schedule.getTimeInterval().high,this._schedule.advance(e),this._load(e),t=this._processScheduleEvents(e,this._schedule.pop(e)),this.eventifyTriggerEvents(t));if(n){var r=!1;if(this._timeout===null)r=!0;else{var s=this._schedule.getNextTaskPoint();s!==null&&s!==this._currentTimeoutPoint&&(r=!0)}if(r){this._clearTimeout();var o=this._clock.now(),u=this._schedule.getDelayNextTs(o);this._currentTimeoutPoint=s;var a=this;this._timeout=this._clock.setTimeout(function(){a._clearTimeout(),a._main()},u,{anchor:o,early:.005})}}},h.prototype._clearTimeout=function(){this._currentTimeoutPoint=null,this._timeout!==null&&(this._timeout.cancel(),this._timeout=null)},h.prototype._load=function(t,s){var o=this._to.vector;if(!i(o))return;var u=this._schedule.getTimeInterval(),a=u.low,f=u.high,l=f-a,c=this._to.range,h=e.calculateVector(o,a),p=s;if(!p){var d=e.calculateInterval(h,l),v=Math.max(d[0],c[0]),m=Math.min(d[1],c[1]),g=new n(v,m,!0,!0);this._schedule.setPosInterval(g),p=this._axis.lookupByInterval(g)}var y=e.calculateSolutionsInInterval(h,l,p),b=e.calculateDelta(h,c)[0];y.forEach(function(n){var i=n[0],s=n[1],u=!0;i===0&&(u=!1),i>b&&(u=!1),i===b&&(u=!1);if(s.pointType===r.PointType.LOW||s.pointType===r.PointType.HIGH){var f=e.calculateVector(o,a+i);f.velocity===0&&(u=!1)}u&&this._schedule.push(t,a+i,s)},this)},h.prototype._processScheduleEvents=function(t,n){var i,a=[],f=e.calculateVector(this._to.vector,t),c=e.calculateDirection(f,t),h=this._clock.now();return n.forEach(function(e){if(e.task.interval.singular)a.push(new l(this,e.task.key,e.task.interval,e.task.data,c,e.task.point,h,e.ts,u.NONE,s.ENTER)),a.push(new l(this,e.task.key,e.task.interval,e.task.data,c,e.task.point,h,e.ts,u.NONE,s.EXIT));else{var t=o.fromInteger(c),n=this._axis.getPointType(e.task.point,e.task.interval),i=r.PointType.toInteger(n),f=i*c*-1,p=s.fromInteger(f);a.push(new l(this,e.task.key,e.task.interval,e.task.data,c,e.task.point,h,e.ts,u.NONE,p))}},this),this._makeEvents(t,a,c)},h.prototype._processIntervalEvents=function(t,n,r,i){if(n.length+r.length+i.length===0)return;var o=e.calculateVector(this._to.vector,t),a=e.calculateDirection(o,t),f=this._clock.now(),c=[],h;n.forEach(function(e){h=e.opType||u.NONE,c.push(new l(this,e.key,e.interval,e.data,a,o.position,f,t,h,s.EXIT))},this),r.forEach(function(e){h=e.opType||u.NONE,c.push(new l(this,e.key,e.interval,e.data,a,o.position,f,t,h,s.ENTER))},this),i.forEach(function(e){c.push(new l(this,e.key,e.interval,e.data,a,o.position,f,t,u.UPDATE,s.NONE))},this),this.eventifyTriggerEvents(this._makeEvents(t,c,a))},h.prototype._processInitialEvents=function(){var t,n,r=this._clock.now(),i=e.calculateVector(this._to.vector,r),o=e.calculateDirection(i,r),a=this._clock.now();return Object.keys(this._activeKeys).map(function(e){return t=this._axis.getItem(e),n=new l(this,e,t.interval,t.data,o,i.position,a,r,u.INIT,s.ENTER),n},this).sort(function(e,t){return e.interval.low-t.interval.low})},h.prototype._makeEvents=function(e,t,n){if(t.length===0)return[];var r,i=[];return t.forEach(function(e){e.exit&&this._activeKeys.hasOwnProperty(e.key)&&delete this._activeKeys[e.key],e.enter&&(this._activeKeys.hasOwnProperty(e.key)||(this._activeKeys[e.key]=undefined)),i.push(e)},this),i=this._reorderEventList(i,n),i.map(function(e){return{type:e.type,e:e}})},h.prototype._reorderEventList=function(e,t){if(e.length<2)return e;var n,i,o=[],u={a:[],x:[],b:[],c:[],y:[],d:[]};return e.sort(function(e,t){return e.interval.low-t.interval.low}).forEach(function(e){if(e.point!==n||e.dueTs!==i)t>=0?o=o.concat(u.a,u.x,u.b,u.c,u.y,u.d):o=o.concat(u.d,u.y,u.c,u.b,u.x,u.a),u={a:[],x:[],b:[],c:[],y:[],d:[]},n=e.point,i=e.dueTs;if(e.pointType===r.PointType.SINGULAR)e.type===s.ENTER?u.b.push(e):u.c.push(e);else{var a=!1;e.pointType===r.PointType.LOW&&e.interval.lowInclude?a=!0:e.pointType===r.PointType.HIGH&&e.interval.highInclude&&(a=!0),e.type===s.ENTER?a?u.x.push(e):u.d.push(e):a?u.y.push(e):u.a.push(e)}},this),t>=0?o.concat(u.a,u.x,u.b,u.c,u.y,u.d):o.concat(u.d,u.y,u.c,u.b,u.x,u.a)},h.prototype.addCue=function(e,t,n){return this.updateAll([{key:e,interval:t,data:n}])},h.prototype.removeCue=function(e,t){return this.updateAll([{key:e,interval:undefined,data:t}])},h.prototype.hasCue=function(e){return this._axis.hasKey(e)},h.prototype.keys=function(){return this._axis.keys()},h.prototype.getCue=function(e){if(this._axis.hasKey(e))return new c(this._axis.getItem(e))},h.prototype.getCues=function(){return this.keys().map(function(e){return this.getCue(e)},this)},h.prototype.isActive=function(e){return this._activeKeys.hasOwnProperty(e)},h.prototype.getActiveKeys=function(){return Object.keys(this._activeKeys)},h.prototype.getActiveCues=function(){return Object.keys(this._activeKeys).map(function(e){return this.getCue(e)},this)},h.prototype.get=function(e){return this.isActive(e)?this.getCues(e).map(function(e){return e.data}):undefined},h.prototype.items=function(){return this.getActiveCues().map(function(e){return e.data})},h.prototype.getCuesByPoint=function(e){return this._axis.lookupByPoint(e).map(function(e){return this.getCue(e.key)},this)},h.prototype.getCuesByInterval=function(e){var t={};return this._axis.lookupByInterval(e).forEach(function(e){t[e.key]=e.interval}),Object.keys(t).map(function(e){return this.getCue(e)},this).filter(function(t){return e.overlapsInterval(t.interval)},this)},h.prototype.getCuesCoveredByInterval=function(e){return this.getCuesByInterval(e).filter(function(t){return e.coversInterval(t.interval)?!0:!1},this)},h.prototype.close=function(){this._to.off("change",this._wrappedOnTimingChange,this),this._axis.off("change",this._wrappedOnAxisChange,this),this._timeout!==null&&(this._timeout.cancel(),this._timeout=null)},{Interval:n,DefaultSequencer:h,Axis:r.Axis,SequencerError:f}}),define("sequencing/windowsequencer",["util/eventify","util/motionutils","./axis","./sequencer"],function(e,t,n,r){"use strict";var i=r.Interval,s=function(t,i,s){this._axis=s||new n.Axis,this._toA=t,this._toB=i,this._seqA=new r.DefaultSequencer(this._toA,this._axis),this._seqB=new r.DefaultSequencer(this._toB,this._axis),this._readyA=!1,this._readyB=!1,this._activeKeys={},e.eventifyInstance(this),this.eventifyDefineEvent("change",{init:!0}),this.eventifyDefineEvent("remove"),this._wrappedOnAxisChange=function(e){var t=e.map(function(e){return e.e});this._onAxisChange(t)},this._wrappedOnTimingChangeA=function(){this._onTimingChangeA()},this._wrappedOnTimingChangeB=function(){this._onTimingChangeB()},this._wrappedOnSequencerChangeA=function(e){this._onSequencerChangeA(e)},this._wrappedOnSequencerChangeB=function(e){this._onSequencerChangeB(e)},this._toA.on("change",this._wrappedOnTimingChangeA,this),this._toB.on("change",this._wrappedOnTimingChangeB,this),this._seqA.on("events",this._wrappedOnSequencerChangeA,this),this._seqB.on("events",this._wrappedOnSequencerChangeB,this)};return e.eventifyPrototype(s.prototype),Object.defineProperty(s.prototype,"Interval",{get:function(){return i}}),s.prototype._setReadyA=function(){this._readyA||(this._readyA=!0,this._readyB&&this._onReady())},s.prototype._setReadyB=function(){this._readyB||(this._readyB=!0,this._readyA&&this._onReady())},s.prototype._isReady=function(){return this._readyA&&this._readyB},s.prototype._onReady=function(){this._axis.on("events",this._wrappedOnAxisChange,this)},s.prototype._onTimingChangeA=function(){this._setReadyA(),this._reevaluate()},s.prototype._onTimingChangeB=function(){this._setReadyB(),this._reevaluate()},s.prototype._onAxisChange=function(e){this._reevaluate(e)},s.prototype._onSequencerChangeA=function(){this._reevaluate()},s.prototype._onSequencerChangeB=function(){this._reevaluate()},s.prototype.eventifyMakeInitEvents=function(e){return e==="change"?Object.keys(this._activeKeys).map(function(e){var t=this._axis.getItem(e);return{key:e,interval:t.interval,data:t.data,type:"change",op:"init",enter:!0,exit:!1}},this):[]},s.prototype._getActiveInterval=function(){var e=this._toA.query(),t=this._toB.query(),n=Math.min(e.position,t.position),r=Math.max(e.position,t.position);return new i(n,r,!0,!0)},s.prototype._getOpFromAxisOpList=function(e,t){var n={};if(e)for(var r=0;r<e.length;r++){var i=e[r];if(i.key===t){n=i;break}}return n},s.prototype._getItem=function(e,t){var n;return e?n=this._getOpFromAxisOpList(e,t):(n=this._axis.getItem(t),n.type="none"),n},s.prototype._reevaluate=function(e){if(!this._isReady())return[];var t=this._getActiveInterval(),n=this._axis.lookupKeysByInterval(t),r=Object.keys(this._activeKeys).filter(function(e){return!n.hasOwnProperty(e)}),i=Object.keys(n).filter(function(e){return!this._activeKeys.hasOwnProperty(e)},this),s=[];e&&e.forEach(function(e){this._activeKeys.hasOwnProperty(e.key)&&n.hasOwnProperty(e.key)&&s.push(e.key)},this),this._activeKeys=n;var o,u=[];r.forEach(function(t){o=this._getItem(e,t),u.push({type:"remove",e:{key:t,interval:o.interval,type:"remove",data:o.data,op:o.type,enter:!1,exit:!0}})},this),i.forEach(function(t){o=this._getItem(e,t),u.push({type:"change",e:{key:t,interval:o.interval,type:"change",data:o.data,op:o.type,enter:!0,exit:!1}})},this),s.forEach(function(t){o=this._getItem(e,t),u.push({type:"change",e:{key:t,interval:o.interval,type:"change",data:o.data,op:o.type,enter:!1,exit:!1}})},this),this.eventifyTriggerEvents(u)},s.prototype.addCue=function(e,t,n){return this._seqA.addCue(e,t,n)},s.prototype.removeCue=function(e){return this._seqA.removeCue(e)},s.prototype.hasCue=function(e){return this._seqA.hasCue(e)},s.prototype.keys=function(){return this._seqA.keys()},s.prototype.getCue=function(e){return this._seqA.getCue(e)},s.prototype.getCues=function(){return this._seqA.getCues()},s.prototype.isActive=function(e){return this._activeKeys.hasOwnProperty(e)},s.prototype.getActiveKeys=function(){return Object.keys(this._activeKeys)},s.prototype.getActiveCues=function(){return Object.keys(this._activeKeys).map(function(e){return this.getCue(e)},this)},s.prototype.get=function(e){return this.isActive(e)?this.getCues(e).map(function(e){return e.data}):undefined},s.prototype.items=function(){return this.getActiveCues().map(function(e){return e.data})},s.prototype.getCuesByPoint=function(e){return this._seqA.getCuesByPoint(e)},s.prototype.getCuesByInterval=function(e){return this._seqA.getCuesByInterval(e)},s.prototype.getCuesCoveredByInterval=function(e){return this._seqA.getCuesCoveredByInterval(e)},s.prototype.close=function(){this._axis.off("change",this._wrappedOnAxisChange),this._toA.off("change",this._wrappedOnTimingChangeA),this._toB.off("change",this._wrappedOnTimingChangeB),this._seqA.off("events",this._wrappedOnSequencerChangeA),this._seqB.off("events",this._wrappedOnSequencerChangeB),this._seqA.close(),this._seqB.close()},s}),define("sequencing/timingcallbacks",["util/motionutils"],function(e){"use strict";var t=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.uber=t.prototype,e.prototype.constructor=e},n=function(e,t){this._timingsrc=e,this._handler=t,this._timeout=null,this._wrappedOnChange=function(){this._onChange()},this.timingsrc=e};n.prototype._renewTimeout=function(){this._clearTimeout();var e=this._calculateTimeout();if(e.delay===null)return null;var t=this;this._timeout=this._timingsrc.clock.setTimeout(function(){t._onTimeout()},e.delay,{anchor:e.anchor,early:.005})},n.prototype._clearTimeout=function(){this._timeout!==null&&(this._timeout.cancel(),this._timeout=null)},n.prototype.cancel=function(){this._clearTimeout(),this._timingsrc.off("change",this._wrappedOnChange,this)},Object.defineProperty(n.prototype,"timingsrc",{get:function(){return this._timingsrc},set:function(e){this._timingsrc&&this._timingsrc.off("change",this._wrappedOnChange,this),clearTimeout(this._tid),this._timingsrc=e,this._timingsrc.on("change",this._wrappedOnChange,this)}});var r=function(e,t,r,i){n.call(this,e,t),this._options=i||{},this._options.repeat=this._options.repeat!==undefined?this._options.repeat:!1,this._point=r};t(r,n),r.prototype._onChange=function(){this._timingsrc.query().position===this._point&&this._handler(),this._renewTimeout()},r.prototype._onTimeout=function(){this._options.repeat||this.cancel(),this._handler(),this._renewTimeout()},r.prototype._calculateTimeout=function(){var t=this._timingsrc.query(),n=e.calculateMinPositiveRealSolution(t,this._point);return{anchor:t.timestamp,delay:n}};var i=function(e,t,r,i){n.call(this,e,t),this._options=i||{},this._options.offset=this._options.offset!==undefined?this._options.offset:0,this._length=r};return t(i,n),i.prototype._mod=function(e,t){return(e%t+t)%t},i.prototype._getPoint=function(e){var t=this._options.offset;return{n:Math.floor((e-t)/this._length),offset:this._mod(e-t,this._length)}},i.prototype._getFloat=function(e){var t=this._options.offset;return t+e.n*this._length+e.offset},i.prototype._onChange=function(){var e=this._calculatePoints(this._timingsrc.query().position);e.isTarget&&this._handler(),this._renewTimeout()},i.prototype._onTimeout=function(){this._handler(),this._renewTimeout()},i.prototype._calculatePoints=function(e){var t={},n={},r,i=this._getPoint(e);return i.offset===0?(r=!0,t.n=i.n-1,t.offset=i.offset,n.n=i.n+1,n.offset=i.offset):(r=!1,t.n=i.n,t.offset=0,n.n=i.n+1,n.offset=0),{isTarget:r,before:this._getFloat(t),after:this._getFloat(n)}},i.prototype._calculateTimeout=function(){var t=this._timingsrc.query(),n=this._calculatePoints(t.position),r=e.calculateDelta(t,[n.before,n.after])[0];return{anchor:t.timestamp,delay:r}},{setPointCallback:function(e,t,n,i){return new r(e,t,n,i)},setIntervalCallback:function(e,t,n,r){return new i(e,t,n,r)}}}),define("sequencing/main",["./sequencer","./windowsequencer","./timingcallbacks"],function(e,t,n){"use strict";var r=function(n,r,i){return r===undefined?new e.DefaultSequencer(n,i):new t(n,r,i)};return{Sequencer:r,Interval:e.Interval,inherit:e.inherit,setPointCallback:n.setPointCallback,setIntervalCallback:n.setIntervalCallback}}),define("mediasync/mediasync",[],function(){"use strict";function t(t){if(e===!1)return!1;if(t.canplay)return e=!1,!1;var n=t.muted;return t.muted=!0,t.play(),e=t.paused==1,t.pause(),t.muted=n,e}function n(e,t,n){function c(){if(l.vel==1)try{e.play()}catch(t){V("error",{event:"error",op:"play"}),console.log("Error in 'play':",t)}}function p(){console.log("onplay"),l.vel==0&&e.pause()}function d(){console.log(err),m(),V("error",{event:"error",msg:err})}function A(t){return i.loop?i.duration?t%i.duration:t%e.duration:t}function K(){if(!i.debug)return;if(typeof i.debug=="function"){var e=arguments;setTimeout(function(){i.debug.apply(window,e)},0)}else{var e=[];for(var t in arguments)e.push(arguments[t]);console.log(JSON.stringify(e))}}var r,i=n||{};i.skew=i.skew||0,i.target=i.target||.025,i.original_target=i.target,i.loop=i.loop||!1,i.target=i.target*2,i.remember===undefined&&(i.remember=!1);if(i.debug||i.remember===!1)localStorage.removeItem("mediascape_vpbr"),i.remember=!1;i.automute===undefined&&(i.automute=!0);var s=!1,o=function(e){y=0,E=[],C=null;if(a||f)return;g!=undefined?g(e):console.log("WARNING: onchange but no update func yet")},u=function(e){y=0,l&&l.off("change",o),l=e,l.version==3&&(l.__defineGetter__("pos",function(){return l.query().position}),l.__defineGetter__("vel",function(){return l.query().velocity}),l.__defineGetter__("acc",function(){return l.query().acceleration})),l.on("change",o)};t||console.log("WARNING: No motion has been set");var a=!1,f=!1,l,v=function(e){e==undefined&&(e=!0),f=e,f||o()},m=function(){a=!0,e.removeEventListener("paused",c),e.removeEventListener("play",p),e.removeEventListener("error",d)},g,y=0,b=0,w,E=[],S,x=0,T=5,N=!1,C,k=0,L=function(t){if(e.readyState==0)return;if(l.vel!=1){e.currentTime=t,C=undefined,V("skip",{event:"skip",pos:t,target:l.pos,adjust:0});return}var n=0,r=performance.now();if(C){r-C.ts<1500?(k+=1,k>3&&(K("Lost all confidence (thrashing)"),i.target=Math.min(1,i.target*2),V("target_change",{event:"target_change",target:i.target,reason:"thrashing"}),k=0)):k=0;var s=(r-C.ts)/1e3,o=e.currentTime,u=A(C.pos+s)-o;n=C.adjust+u,Math.abs(n)>5&&(n=0)}e.playbackRate=1,K({type:"skip",pos:t+n,target:A(l.pos),adjust:n}),T=Math.min(5,T+5),l.vel!=1?e.currentTime=t:(e.currentTime=t+n,C={ts:r,pos:t,adjust:n}),N&&(N=!1,V("sync",{event:"sync",sync:!1})),V("skip",{event:"skip",pos:t+n,target:l.pos,adjust:n})},O=function(t){if(a||f)return;var n=I();if(A(n.pos)==w)return;w=A(n.pos);var r=A(n.pos+i.skew),o=e.duration;if(o)if(r<0||r>o){e.paused||e.pause();return}n.vel!=0?e.paused&&e.play():e.paused||e.pause();try{if(!S&&y>40)throw s&&(e.muted=!1,s=!1),V("muted",{event:"muted",muted:!1}),new Error("Variable playback rate seems broken - "+y+" bad");var u=r-e.currentTime;if(u<-1||n.vel==0||Math.abs(u)>1){K({type:"jump",diff:u});var c=A(n.pos+i.skew);performance.now()-x>150&&(x=performance.now(),L(c));return}E.push(u);if(!(E.length>=3))return;var h=0;for(var p=0;p<E.length;p++)h+=E[p];u=h/E.length,E=E.splice(0,1),K({type:"dbg",diff:u,bad:y,vpbr:S});var d=function(e,t){return Math.min(l.vel+e,Math.max(l.vel-e,l.vel+t))};Math.abs(u)>1?(E=[],e.playbackRate=d(1,u*1.3),K({type:"vpbr",level:"coarse",rate:e.playbackRate}),y+=4):Math.abs(u)>.5?(E=[],e.playbackRate=d(.5,u*.75),K({type:"vpbr",level:"mid",rate:e.playbackRate}),y+=2):Math.abs(u)>.1?(E=[],e.playbackRate=d(.4,u*.75),K({type:"vpbr",level:"midfine",rate:e.playbackRate}),y+=1):Math.abs(u)>.025?(E=[],e.playbackRate=d(.3,u*.6),K({type:"vpbr",level:"fine",rate:e.playbackRate})):(S||(y=Math.max(0,y-20),b++,b>5&&(S=!0,localStorage&&i.remember&&(K("Variable Playback Rate capability stored"),localStorage.mediascape_vpbr=JSON.stringify({appVersion:navigator.appVersion,vpbr:!0})))),N||(N=!0,V("sync",{event:"sync",sync:!0})),e.playbackRate=d(.02,u*.07)),i.automute&&(!e.muted&&(e.playbackRate>1.05||e.playbackRate<.95)?(s=!0,e.muted=!0,V("muted",{event:"muted",muted:!0}),K({type:"mute",muted:!0})):e.muted&&s&&(s=!1,e.muted=!1,K({type:"mute",muted:!1}),V("muted",{event:"muted",muted:!1})))}catch(v){i.automute&&(e.muted=!1),C=null,localStorage&&i.remember&&(K("Variable Playback Rate NOT SUPPORTED, remembering this  "),localStorage.mediascape_vpbr=JSON.stringify({appVersion:navigator.appVersion,vpbr:!1})),console.log("Error setting variable playback speed - seems broken",v),F(D)}},M,_,D=function(t){if(a||f)return;var n=I();n.vel>0?e.paused&&e.play():e.paused||e.pause();if(n.vel!=1){if(A(n.pos)==M)return;M=n.pos,K("Jump, playback speed is not :",n.vel);var r=A(n.pos+i.skew);e.currentTime!=r&&L(r,"jump");return}var s=n.pos+i.skew,o=s-e.currentTime;if(t!=undefined&&t.pos!=undefined){K("MOTION JUMP");var r=n.pos+i.skew;L(r);return}E.push(o);if(!(E.length>=3))return;var u=0;for(var c=0;c<E.length;c++)u+=E[c];o=u/E.length,E.splice(0,1),Math.abs(o)<.001&&(T=Math.max(5,T)),T<=-2?(K("Lost all confidence"),i.target=Math.min(1,i.target*1.4),T=0,V("target_change",{event:"target_change",target:i.target,reason:"unknown"})):T>15&&(K("Feels better"),i.target==i.original_target&&(N||(N=!0,V("sync",{event:"sync",sync:!0}))),i.target=Math.max(Math.abs(o)*.7,i.original_target),T-=8,V("target_change",{event:"target_change",target:i.target,reason:"improving"})),K({type:"dbg",diff:o,target:i.target,perfect:T});if(Math.abs(o)>i.target){T-=1;if(T>0)return;r=l.pos+i.skew,T+=8,L(r)}else Math.abs(o-_)<i.target/2&&T++,_=o},P=!1,H=function(){if(P)return;P=!0,l===undefined&&u(t);if(localStorage&&i.remember&&localStorage.mediascape_vpbr){var n=JSON.parse(localStorage.mediascape_vpbr);n.appVersion===navigator.appVersion&&(S=n.vpbr)}i.mode==="vpbr"&&(S=!0),i.mode==="skip"||S===!1?(e.playbackRate=1,g=D):(i.automute&&(e.muted=!0,s=!0,V("muted",{event:"muted",muted:!0})),g=O),e.removeEventListener("canplay",H),e.removeEventListener("playing",H),F(g),l.on("change",o)};e.addEventListener("canplay",H),e.addEventListener("playing",H);var B,j,F=function(t){B&&(clearInterval(j),e.removeEventListener("timeupdate",B),e.removeEventListener("pause",B),e.removeEventListener("ended",B)),B=t,e.playbackRate=1,e.addEventListener("timeupdate",t),e.addEventListener("pause",t),e.addEventListener("ended",t),t===O?V("mode_change",{event:"mode_change",mode:"vpbr"}):V("mode_change",{event:"mode_change",mode:"skip"})},I=function(){if(l.version==3){var e=l.query();return{pos:e.position,vel:e.velocity,acc:e.acceleration}}return l.query()},q=function(e){i.skew=e},R=function(){return i.skew},U=function(e,t){i[e]=t,e==="target"&&(i.original_target=t)},z=function(){return g===O?"playbackRate":"skip"},W=setInterval(function(){if(e.readyState>=2){clearInterval(W);try{var t=new Event("canplay");e.dispatchEvent(t)}catch(n){var t=document.createEvent("Event");t.initEvent("canplay",!0,!1),e.dispatchEvent(t)}}},100),X={skip:[],mode_change:[],target_change:[],muted:[],sync:[],error:[]},V=function(e,t){if(!X.hasOwnProperty(e))throw"Unsupported event: "+e;for(var n=0;n<X[e].length;n++){h=X[e][n];try{h.call(r,t)}catch(t){console.log("Error in "+e+": "+h+": "+t)}}},$=function(e,t){if(!X.hasOwnProperty(e))throw"Unknown parameter "+e;var n=X[e].indexOf(t);return n>-1&&X[e].splice(n,1),r},J=function(e,t,n){if(!X.hasOwnProperty(e))throw new Error("Unsupported event: "+e);if(!t||typeof t!="function")throw"Illegal handler";var i=X[e].indexOf(t);if(i!=-1)throw new Error("Already registered");return X[e].push(t),setTimeout(function(){e==="sync"&&V(e,{event:e,sync:N},t),e==="muted"&&V(e,{event:e,muted:s},t)},0),r};return r={setSkew:q,getSkew:R,setOption:U,getMethod:z,setMotion:u,stop:m,pause:v,on:J,off:$,init:H},r}var e,r=function(e,t,r){this._sync=n(e,t,r)};return r.prototype.setSkew=function(e){this._sync.setSkew(e)},r.prototype.getSkew=function(){this._sync.getSkew()},r.prototype.setOption=function(e,t){this._sync.setOption(e,t)},r.prototype.getMethod=function(){this._sync.getMethod()},Object.defineProperty(r.prototype,"timingsrc",{get:function(){return this._sync._motion},set:function(e){this._sync.setMotion(e)}}),r.prototype.stop=function(){this._sync.stop()},r.prototype.pause=function(e){this._sync.pause(e)},r.prototype.on=function(e,t,n){this._sync.on(e,t,n)},r.prototype.off=function(e,t){this._sync.off(e,t)},{mediaSync:n,MediaSync:r,mediaNeedKick:t}}),define("timingsrc",["./timingobject/main","./sequencing/main","./mediasync/mediasync"],function(e,t,n){return{version:"v2",inherit:e.inherit,TimingObject:e.TimingObject,TimingProviderState:e.TimingProviderState,ConverterBase:e.ConverterBase,SkewConverter:e.SkewConverter,DelayConverter:e.DelayConverter,ScaleConverter:e.ScaleConverter,LoopConverter:e.LoopConverter,RangeConverter:e.RangeConverter,TimeShiftConverter:e.TimeShiftConverter,LocalConverter:e.LocalConverter,DerivativeConverter:e.DerivativeConverter,Interval:t.Interval,Sequencer:t.Sequencer,setPointCallback:t.setPointCallback,setIntervalCallback:t.setIntervalCallback,MediaSync:n.MediaSync,mediaNeedKick:n.needKick}});