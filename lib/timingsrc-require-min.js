/*
	Copyright 2015 Norut Northern Research Institute
	Author : Ingar Mæhlum Arntzen

  This file is part of the Timingsrc module.

  Timingsrc is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Timingsrc is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with Timingsrc.  If not, see <http://www.gnu.org/licenses/>.
*/

/*
    Copyright 2015 Norut Northern Research Institute
    Author : Ingar Mæhlum Arntzen

  This file is part of the Timingsrc module.

  Timingsrc is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Timingsrc is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with Timingsrc.  If not, see <http://www.gnu.org/licenses/>.
*/

/**
 * MediaSync
 *
 * author: njaal.borch@motioncorporation.com
 *
 * Copyright 2015
 * License: LGPL
 */

define("util/eventutils",[],function(){"use strict";var e=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return function(n){n=n||e;var r="";for(var i=0;i<n;i++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}}(10);Array.prototype.concatAll=function(){var e=[];return this.forEach(function(t){e.push.apply(e,t)},this),e},Array.prototype.concatMap=function(e,t){return this.map(function(n){return e.call(t,n)}).concatAll()};var t=function(){this._id=0,this._map={}};t.prototype._newID=function(){return this._id+=1,this._id},t.prototype._getID=function(e){var t,n=Object.keys(this._map).filter(function(n){return t=this._map[n],t.handler===e},this);return n.length>0?n[0]:-1},t.prototype.getItem=function(e){return this._map[e]},t.prototype.register=function(e,t){var n=this._getID(e);if(n>-1)throw new Error("handler already registered");return n=this._newID(),this._map[n]={ID:n,handler:e,ctx:t,count:0,pending:!1},n},t.prototype.unregister=function(e){var t=this._getID(e);t!==-1&&delete this._map[t]},t.prototype.getItems=function(){return Object.keys(this._map).map(function(e){return this.getItem(e)},this)};var n=function(n,r){return n._ID=e(4),n._callbacks={},n._callbacks.events=new t,n._callbacks.events._options={init:!0},r.eventifyDefineEvent=function(e,n){if(e==="events")throw new Error("Illegal event type : 'events' is protected");n=n||{},n.init=n.init===undefined?!1:n.init,this._callbacks[e]=new t,this._callbacks[e]._options=n},r._eventifyMakeInitEvents=function(e){var t=this.eventifyMakeInitEvents||function(e){return[]},n;return e!=="events"?n=[e]:n=Object.keys(this._callbacks).filter(function(t){return t!=="events"&&this._callbacks[e]._options.init},this),n.concatMap(function(e){return t.call(this,e)},this)},r._eventifyEventFormatter=function(e,t){var n=this.eventifyEventFormatter||function(e,t){return t};return e==="events"&&(t=t.map(function(e){return n.call(this,e.type,e.e)})),n(e,t)},r._eventifyCallbackFormatter=function(e,t,n){var r=this.eventifyCallbackFormatter||function(e,t,n){return[t]};return r.call(this,e,t,n)},r.eventifyTriggerEvents=function(e){e.forEach(function(e){if(e.type===undefined)throw new Error("Illegal event type; undefined");if(e.type==="events")throw new Error("Illegal event type; triggering of events on protocted event type 'events'")},this);if(e.length===0)return;return this._eventifyTriggerEvents(e),this},r.eventifyTriggerEvent=function(e,t){return this.eventifyTriggerEvents([{type:e,e:t}])},r._eventifyTriggerEvents=function(e,t){this._eventifyTriggerEvent("events",{type:"events",e:e},t),e.forEach(function(e){this._eventifyTriggerEvent(e.type,e,t)},this)},r._eventifyTriggerEvent=function(e,t,n){var r,i,s={};if(!this._callbacks.hasOwnProperty(e))throw new Error("Unsupported event type "+e);var o=this._callbacks[e],u=o._options.init;return o.getItems().forEach(function(o){if(n===undefined){if(o.pending)return!1}else{if(o.ID!==n)return!1;s.init=!0,o.pending=!1}u&&(s.init=o.ID===n?!0:!1),s.count=o.count,s.src=this,i=this._eventifyEventFormatter(t.type,t.e),r=this._eventifyCallbackFormatter(e,i,s);try{return o.handler.apply(o.ctx,r),o.count+=1,!0}catch(a){console.log("Error in "+e+": "+o.handler+" "+o.ctx+": ",a)}},this),!1},r.on=function(e,t,n){if(!t||typeof t!="function")throw new Error("Illegal handler");if(!this._callbacks.hasOwnProperty(e))throw new Error("Unsupported event type "+e);var r=this._callbacks[e];n=n||this;var i=r.register(t,n);if(r._options.init){var s=r.getItem(i);s.pending=!0;var o=this;setTimeout(function(){var t=o._eventifyMakeInitEvents(e);t.length>0?o._eventifyTriggerEvents(t,i):s.pending=!1},0)}return this},r.off=function(e,t){if(this._callbacks[e]!==undefined){var n=this._callbacks[e];n.unregister(t)}return this},n};return{eventify:n}}),define("util/motionutils",[],function(){"use strict";var e=function(e,t){if(t===undefined)throw new Error("no ts provided for calculateVector");var n=t-e.timestamp;return{position:e.position+e.velocity*n+.5*e.acceleration*n*n,velocity:e.velocity+e.acceleration*n,acceleration:e.acceleration,timestamp:t}},t=function(e,t){if(e>t)return 1;if(e===t)return 0;if(e<t)return-1},n=function(n,r){var i=e(n,r),s=t(i.velocity,0);return s===0&&(s=t(n.acceleration,0)),s},r=function(e,t,n,r){return Math.pow(t,2)-2*n*(e-r)>=0?!0:!1},i=function(e,t,n,i){if(n===0&&t===0)return e!=i?[]:[0];if(n===0)return[(i-e)/t];if(r(e,t,n,i)===!1)return[];var s=t*t-2*n*(e-i);if(s===0)return[-t/n];var o=Math.sqrt(Math.pow(t,2)-2*n*(e-i)),u=(-t+o)/n,a=(-t-o)/n;return[Math.min(u,a),Math.max(u,a)]},s=function(e,t,n,r){var s=i(e,t,n,r);return s.length===0?[]:s.length==1?s[0]>0?[s[0]]:[]:s.length==2?s[1]<0?[]:s[0]>0?[s[0],s[1]]:s[1]>0?[s[1]]:[]:[]},o=function(e,t,n,r){var i=s(e,t,n,r);return i.length===0?null:i[0]},u=function(e,t){var n=e.position,r=e.velocity,i=e.acceleration,s=o(n,r,i,t[0]),u=o(n,r,i,t[1]);return s!==null&&u!==null?s<u?[s,t[0]]:[u,t[1]]:s!==null?[s,t[0]]:u!==null?[u,t[1]]:[null,null]},a=function(e,t){return e[0]-t[0]},f=function(e,t,n){var r=[],s=e.position,o=e.velocity,u=e.acceleration;for(var f=0;f<n.length;f++){var l=n[f],c=i(s,o,u,l.point);for(var h=0;h<c.length;h++){var p=c[h];0<=p&&p<=t&&r.push([p,l])}}return r.sort(a),r},l=function(e,t){var n=e.position,r=e.velocity,i=e.acceleration,s=n+r*t+.5*i*t*t;if(i!==0){var o=-r/i;if(0<=o&&o<=d){var u=n-.5*r*r/i;return i>0?[u,Math.max(n,s)]:[Math.min(n,s),u]}}return[Math.min(n,s),Math.max(n,s)]};return{calculateVector:e,calculateDirection:n,calculateDelta:u,calculateInterval:l,calculateSolutionsInInterval:f}}),define("timingobject/timingbase",["util/eventutils","util/motionutils"],function(e,t){"use strict";var n=Object.freeze({INIT:"init",INSIDE:"inside",OUTSIDE_LOW:"outsidelow",OUTSIDE_HIGH:"outsidehigh"}),r=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.uber=t.prototype,e.prototype.constructor=e},i=function(t){this._version=3,this._options=t||{},this._options.hasOwnProperty("timeout")||(this._options.timeout=!1),this._vector=null,this._range=null,this._timeout=null,this._tid=null,e.eventify(this,i.prototype),this.eventifyDefineEvent("change",{init:!0}),this.eventifyDefineEvent("timeupdate",{init:!0}),this._internalOnChange=function(){var e=this.timingsrc.vector;this._preProcess(e)}};Object.defineProperty(i.prototype,"version",{get:function(){return this._version}}),Object.defineProperty(i.prototype,"range",{get:function(){return this._range===null?null:[this._range[0],this._range[1]]}}),Object.defineProperty(i.prototype,"vector",{get:function(){return this._vector===null?null:{position:this._vector.position,velocity:this._vector.velocity,acceleration:this._vector.acceleration,timestamp:this._vector.timestamp}}}),i.prototype.eventifyMakeInitEvents=function(e){var t=this.query();return e==="change"?t!==null?[{type:e,e:undefined}]:[]:e==="timeupdate"?t!==null?[{type:e,e:undefined}]:[]:[]},i.prototype.query=function(){return this.vector===null?null:t.calculateVector(this.vector,this.clock.now())},i.prototype.update=function(e){},i.prototype._getRange=function(){return null},i.prototype._preProcess=function(e){this._range===null&&(this._range=this._getRange());var e=this._onChange(e);this._process(e)},i.prototype._onChange=function(e){return e},i.prototype._renewTimeout=function(){if(this._options.timeout===!0){this._clearTimeout();var e=this._calculateTimeoutVector();if(e===null)return;this._timeout={vector:e},this._internalTimeout()}},i.prototype._calculateTimeoutVector=function(){return null},i.prototype._clearTimeout=function(){this._timeout!==null&&(clearTimeout(this._timeout.tid),this._timeout=null)},i.prototype._internalTimeout=function(){if(this._timeout===null)return;var e=this._timeout.vector,t=e.timestamp-this.clock.now();if(t>0){var n=this;this._timeout.tid=setTimeout(function(){n._internalTimeout()},t*1e3);return}e=this._onTimeout(e),this._process(e)},i.prototype._onTimeout=function(e){return e},i.prototype._process=function(e){e!==null&&(this._vector=e,this._postProcess(this.vector)),this._renewTimeout()},i.prototype._postProcess=function(e){this.eventifyTriggerEvent("change"),this.eventifyTriggerEvent("timeupdate");var t=e.velocity!==0||e.acceleration!==0;if(t&&this._tid===null){var n=this;this._tid=setInterval(function(){n.eventifyTriggerEvent("timeupdate")},200)}else!t&&this._tid!==null&&(clearTimeout(this._tid),this._tid=null)},i.prototype._getCorrectRangeState=function(e){var t=e.position,r=e.velocity,i=e.acceleration;if(t>this._range[1])return n.OUTSIDE_HIGH;if(t<this._range[0])return n.OUTSIDE_LOW;if(t===this._range[1]){if(r>0)return n.OUTSIDE_HIGH;if(r===0&&i>0)return n.OUTSIDE_HIGH}else if(t===this._range[0]){if(r<0)return n.OUTSIDE_LOW;if(r==0&&i<0)return n.OUTSIDE_HIGH}return n.INSIDE},i.prototype._checkRange=function(e){var t=this._getCorrectRangeState(e);return t!==n.INSIDE&&(e.velocity=0,e.acceleration=0,t===n.OUTSIDE_HIGH?e.position=this._range[1]:e.position=this._range[0]),e};var s=function(e,t){i.call(this,t),this._timingsrc=null,this.timingsrc=e};return r(s,i),Object.defineProperty(s.prototype,"clock",{get:function(){return this.timingsrc.clock}}),Object.defineProperty(s.prototype,"timingsrc",{get:function(){return this._timingsrc},set:function(e){this._timingsrc&&this._timingsrc.off("change",this._internalOnChange,this),this._range=null,this._vector=null,this._clearTimeout(),clearTimeout(this._tid),this._timingsrc=e,this._timingsrc.on("change",this._internalOnChange,this)}}),s.prototype.update=function(e,t,n){return this.timingsrc.update(e,t,n)},s.prototype._getRange=function(){return this.timingsrc.range},{TimingBase:i,ConverterBase:s,STATE:n,inherit:r,motionutils:t}}),define("timingobject/skewconverter",["./timingbase"],function(e){"use strict";var t=e.ConverterBase,n=e.inherit,r=function(e,n){this._skew=n,t.call(this,e)};return n(r,t),r.prototype._getRange=function(){var e=this.timingsrc.range;return e[0]=e[0]===-Infinity?e[0]:e[0]+this._skew,e[1]=e[1]===Infinity?e[1]:e[1]+this._skew,e},r.prototype._onChange=function(e){return e.position+=this._skew,e},r.prototype.update=function(e){return e.position!==undefined&&e.position!==null&&(e.position=e.position-this._skew),this.timingsrc.update(e)},r}),define("timingobject/delayconverter",["./timingbase"],function(e){"use strict";var t=e.ConverterBase,n=e.inherit,r=function(e,n){if(n<0)throw new Error("negative delay not supported");if(n===0)throw new Error("zero delay makes delayconverter pointless");t.call(this,e),this._delay=n};return n(r,t),r.prototype._onChange=function(e){var t=this.clock.now()-e.timestamp;e.timestamp+=this._delay;if(t<this._delay){var n=this,r=(this._delay-t)*1e3;return setTimeout(function(){n._process(e)},r),null}return e},r.prototype.update=function(e){throw new Error("update is not legal on delayed (non-live) timingobject")},r}),define("timingobject/scaleconverter",["./timingbase"],function(e){"use strict";var t=e.ConverterBase,n=e.inherit,r=function(e,n){this._factor=n,t.call(this,e)};return n(r,t),r.prototype._getRange=function(){var e=this.timingsrc.range;return[e[0]/this._factor,e[1]/this._factor]},r.prototype._onChange=function(e){return e.position=e.position/this._factor,e.velocity=e.velocity/this._factor,e.acceleration=e.acceleration/this._factor,e},r.prototype.update=function(e){return e.position!==undefined&&e.position!==null&&(e.position=e.position*this._factor),e.velocity!==undefined&&e.velocity!==null&&(e.velocity=e.velocity*this._factor),e.acceleration!==undefined&&e.acceleration!==null&&(e.acceleration=e.acceleration*this._factor),this.timingsrc.update(e)},r}),define("timingobject/loopconverter",["./timingbase"],function(e){"use strict";var t=e.motionutils,n=e.ConverterBase,r=e.inherit,i=function(e,t){this.skew=e,this.length=t};i.mod=function(e,t){return(e%t+t)%t},i.prototype.getPoint=function(e){return{n:Math.floor((e-this.skew)/this.length),offset:i.mod(e-this.skew,this.length)}},i.prototype.getFloat=function(e){return this.skew+e.n*this.length+e.offset},i.prototype.transformFloat=function(e,t){t=t===undefined?this.skew:t;var n=this.getPoint(e),r=this.getPoint(t);return this.getFloat({n:r.n,offset:n.offset})};var s=function(e,t){n.call(this,e,{timeout:!0}),this._range=t,this._coords=new i(t[0],t[1]-t[0])};return r(s,n),s.prototype._transform=function(e){return this._coords.transformFloat(e)},s.prototype._inverse=function(e){var t=this.query().position,n=this.timingsrc.query().position,r=e-t,i=r+n;return i},s.prototype.query=function(){if(this.vector===null)return null;var e=t.calculateVector(this.vector,this.clock.now());if(e.position>this._range[1])e.position=this._range[0],this._main(e);else{if(!(e.position<this._range[0]))return e;e.position=this._range[1],this._main(e)}return t.calculateVector(this.vector,this.clock.now())},s.prototype.update=function(e){return e.position!==undefined&&e.position!==null&&(e.position=this._inverse(e.position)),this.timingsrc.update(e)},s.prototype._calculateTimeoutVector=function(){var e=this.query(),n=t.calculateDelta(e,this.range),r=n[0];if(r===null)return null;var i=n[1],s=t.calculateVector(e,e.timestamp+r);return s.position=i,s},s.prototype._onTimeout=function(e){return e.position>=this._range[1]?e.position=this._range[0]:e.position<=this._range[0]&&(e.position=this._range[1]),e},s.prototype._onChange=function(e){return e.position=this._transform(e.position),e},s}),define("timingobject/rangeconverter",["./timingbase"],function(e){"use strict";var t=e.motionutils,n=e.ConverterBase,r=e.STATE,i=e.inherit,s=function(){var e=r.INIT,t=function(e,t){return e===r.OUTSIDE_HIGH&&t===r.OUTSIDE_LOW?!1:e===r.OUTSIDE_LOW&&t===r.OUTSIDE_HIGH?!1:e===r.INIT?!1:!0},n=function(){return e},i=function(n){if(n===r.INSIDE||n===r.OUTSIDE_LOW||n===r.OUTSIDE_HIGH)if(n!==e){var i=e;return e=n,{real:t(i,n),abs:!0}}return{real:!1,abs:!1}};return{get:n,set:i}},o=function(e,t){n.call(this,e,{timeout:!0}),this._state=s(),this._range=t};return i(o,n),o.prototype.query=function(){if(this.vector===null)return null;var e=t.calculateVector(this.timingsrc.vector,this.clock.now()),n=this._getCorrectRangeState(e);return n!==r.INSIDE&&this._preProcess(e),t.calculateVector(this.vector,this.clock.now())},o.prototype._calculateTimeoutVector=function(){var e=this.timingsrc.query(),n=t.calculateDelta(e,this.range),r=n[0];if(r===null)return null;var i=n[1],s=t.calculateVector(e,e.timestamp+r);return s.position=i,s},o.prototype._onTimeout=function(e){return this._onChange(e)},o.prototype._onChange=function(e){var t=this._getCorrectRangeState(e),n=this._state.set(t);if(n.real)this._state.get()!==r.INSIDE&&(e=this._checkRange(e));else if(this._state.get()!==r.INSIDE){if(!n.abs)return null;e=this._checkRange(e)}return e},o}),define("timingobject/timeshiftconverter",["./timingbase","./rangeconverter"],function(e,t){"use strict";var n=e.motionutils,r=e.ConverterBase,i=e.inherit,s=function(e,t){r.call(this,e),this._timeOffset=t};i(s,r),s.prototype._onChange=function(e){var t=n.calculateVector(e,e.timestamp+this._timeOffset);return t.timestamp=e.timestamp,t};var o=function(e,n,r){return r=r||e.range,new t(new s(e,n),r)};return o}),define("timingobject/localconverter",["./timingbase"],function(e){"use strict";var t=e.ConverterBase,n=e.inherit,r=function(e){t.call(this,e),this._speculative=!1};return n(r,t),r.prototype.update=function(e){var t=this.timingsrc.update(e);this._speculative=!0;var n=this;return setTimeout(function(){n._preProcess(t)},0),t},r.prototype._onChange=function(e){return this._speculative&&(this._speculative=!1),e},r}),define("timingobject/derivativeconverter",["./timingbase"],function(e){"use strict";var t=e.ConverterBase,n=e.inherit,r=function(e,n){t.call(this,e)};return n(r,t),r.prototype._getRange=function(){return[-Infinity,Infinity]},r.prototype._onChange=function(e){var t={position:e.velocity,velocity:e.acceleration,acceleration:0,timestamp:e.timestamp};return t},r.prototype.update=function(e){throw new Error("updates illegal on derivative of timingobject")},r}),define("util/timeoututils",[],function(){"use strict";var e=function(e,t,n,r){this._clock=e,this._wrappedOnClockChange=function(){this._onClockChange()},this._clock.on("change",this._wrappedOnClockChange,this);var i=this._clock.now();this._tid=null,this._callback=t,this._delay_counter=0,this._options=r||{},this._options.anchor=this._options.anchor||i,this._options.early=Math.abs(this._options.early)||0,this._target=this._options.anchor+n;var s=this;window.addEventListener("message",this,!0);var o=this._target-this._clock.now();o>10?this._tid=setTimeout(function(){s._ontimeout()},o-3e3):this._tid=setTimeout(function(){s._ontimeout()},(o-s._options.early)*1e3)};return e.prototype._onClockChange=function(){},e.prototype._ontimeout=function(){if(this._tid!==null){var e=this._target-this._clock.now();if(e<=0)this.cancel(),this._callback();else if(e>this._options.early){var t=this;this._tid=setTimeout(function(){t._ontimeout()},(e-this._options.early)*1e3)}else this._smalldelay()}},e.prototype.handleEvent=function(e){if(e.source===window&&e.data.indexOf("smalldelaymsg_")===0){e.stopPropagation();var t=parseInt(e.data.split("_")[1]);this._tid!==null&&this._tid===t&&this._ontimeout()}},e.prototype._smalldelay=function(){this._delay_counter++;var e=this;window.postMessage("smalldelaymsg_"+e._tid,"*")},e.prototype.cancel=function(){if(this._tid!==null){clearTimeout(this._tid),this._tid=null;var e=this;window.removeEventListener("message",this,!0),this._clock.off("change",this._onClockChange)}},{setTimeout:function(t,n,r,i){return new e(t,n,r,i)}}}),define("util/masterclock",["./eventutils","./timeoututils"],function(e,t){"use strict";(function(){"performance"in window==0&&(window.performance={},window.performance.offset=(new Date).getTime()),"now"in window.performance==0&&(window.performance.now=function(){return(new Date).getTime()-window.performance.offset})})();var n={now:function(){return performance.now()/1e3}},r=function(e,t){var n=t-e.timestamp;return{position:e.position+e.velocity*n,velocity:e.velocity,timestamp:t}},i=function(t){var r=n.now();t=t||{position:r,velocity:1,acceleration:0,timestamp:r},this._vector=t,e.eventify(this,i.prototype),this.eventifyDefineEvent("change",{init:!0})};return i.prototype.adjust=function(e){if(e<=0)throw new Error("negative velocity not supported");var t=this.query();this._vector.position=t.position,this._vector.velocity=e,this._vector.timestamp=t.timestamp,this.eventigyTriggerEvent("change")},i.prototype.now=function(){return r(this._vector,n.now()).position},i.prototype.query=function(){return r(this._vector,n.now())},i.prototype.eventifyMakeInitEvents=function(e){return e==="change"?[{type:e,e:undefined}]:[]},i.prototype.setTimeout=function(e,n,r){return t.setTimeout(this,e,n,r)},i}),define("timingobject/timingobject",["./timingbase","util/masterclock"],function(e,t){"use strict";var n=e.motionutils,r=e.TimingBase,i=e.STATE,s=e.inherit,o=function(e,n){r.call(this,{timeout:!0}),this._clock=new t,this._vector={position:0,velocity:0,acceleration:0,timestamp:this._clock.now()},n&&(n.position===null&&(n.position=undefined),n.velocity===null&&(n.velocity=undefined),n.acceleration===null&&(n.acceleration=undefined),n.position!==undefined&&(this._vector.position=n.position),n.velocity!==undefined&&(this._vector.velocity=n.velocity),n.acceleration!==undefined&&(this._vector.acceleration=n.acceleration)),this._range=e!==undefined?e:[-Infinity,Infinity],this._vector=this._checkRange(this._vector)};return s(o,r),Object.defineProperty(o.prototype,"clock",{get:function(){return this._clock}}),o.prototype.query=function(){if(this.vector===null)return null;var e=n.calculateVector(this.vector,this.clock.now()),t=this._getCorrectRangeState(e);return t!==i.INSIDE&&this._preProcess(e),n.calculateVector(this.vector,this.clock.now())},o.prototype.update=function(e){if(e===undefined||e===null)throw new Error("drop update, illegal updatevector");var t=e.position===undefined||e.position===null?undefined:e.position,r=e.velocity===undefined||e.velocity===null?undefined:e.velocity,i=e.acceleration===undefined||e.acceleration===null?undefined:e.acceleration;if(t===undefined&&r===undefined&&i===undefined)throw new Error("drop update, noop");var s=this._clock.now(),o=n.calculateVector(this.vector,s),u=o.position,a=o.velocity,f=o.acceleration;t=t!==undefined?t:u,r=r!==undefined?r:a,i=i!==undefined?i:f;if(t===u&&r===a&&i===f)return;var l={position:t,velocity:r,acceleration:i,timestamp:s},c=this;return setTimeout(function(){c._preProcess(l)},0),l},o.prototype._onChange=function(e){return this._checkRange(e)},o.prototype._calculateTimeoutVector=function(){var e=this.query(),t=n.calculateDelta(e,this.range),r=t[0];if(r===null)return null;var i=t[1],s=n.calculateVector(e,e.timestamp+r);return s.position=i,s},o.prototype._onTimeout=function(e){return this._checkRange(e)},o}),define("timingobject/main",["./timingbase","./skewconverter","./delayconverter","./scaleconverter","./loopconverter","./rangeconverter","./timeshiftconverter","./localconverter","./derivativeconverter","./timingobject"],function(e,t,n,r,i,s,o,u,a,f){"use strict";return{motionutils:e.motionutils,inherit:e.inherit,ConverterBase:e.ConverterBase,SkewConverter:t,DelayConverter:n,ScaleConverter:r,LoopConverter:i,RangeConverter:s,TimeShiftConverter:o,LocalConverter:u,DerivativeConverter:a,TimingObject:f}}),define("util/interval",[],function(){"use strict";var e=function(e){var t=parseFloat(e);return e===t&&!isNaN(t)},t=function(e){this.name="IntervalError",this.message=e||""};t.prototype=Error.prototype;var n=function(n,r,i,s){var o=e(n),u=e(r);o&&r===undefined&&(r=n);if(!e(n))throw new t("low not a number");if(!e(r))throw new t("high not a number");if(n>r)throw new t("low > high");n===r&&(i=!0,s=!0),n===-Infinity&&(i=!0),r===Infinity&&(s=!0),i===undefined&&(i=!0),s===undefined&&(s=!1);if(typeof i!="boolean")throw new t("lowInclude not boolean");if(typeof s!="boolean")throw new t("highInclude not boolean");this.__defineGetter__("length",function(){return r-n}),this.__defineGetter__("low",function(){return n}),this.__defineGetter__("high",function(){return r}),this.__defineGetter__("lowInclude",function(){return i}),this.__defineGetter__("highInclude",function(){return s})};return n.prototype.toString=function(){var e=this.lowInclude?"[":"<",t=this.highInclude?"]":">",n=this.low===-Infinity?"<--":this.low.toFixed(2),r=this.high===Infinity?"-->":this.high.toFixed(2);return this.isSingular()?e+n+t:e+n+","+r+t},n.prototype.isFinite=function(){return isFinite(this.low)&&isFinite(this.high)},n.prototype.isSingular=function(){return this.low===this.high},n.prototype.coversPoint=function(e){return this.low<e&&e<this.high?!0:this.lowInclude&&e===this.low?!0:this.highInclude&&e===this.high?!0:!1},n.prototype.overlapsInterval=function(e){if(e instanceof n==0)throw new t("paramenter not instance of Interval");return this.isSingular()&&e.isSingular()?this.low===e.low:this.isSingular()?e.coversPoint(this.low):e.isSingular()?this.coversPoint(e.low):this.high<e.low?!1:this.high===e.low?this.coversPoint(e.low)&&e.coversPoint(this.high):this.low>e.high?!1:this.low===e.high?this.coversPoint(e.high)&&e.coversPoint(this.low):!0},n.prototype.coversInterval=function(e){if(e instanceof n==0)throw new t("paramenter not instance of Interval");return e.low<this.low||this.high<e.high?!1:this.low<e.low&&e.high<this.high?!0:this.low===e.low&&this.lowInclude===!1&&e.lowInclude===!0?!1:this.high===e.high&&this.highInclude===!1&&e.highInclude===!0?!1:!0},n.prototype.equals=function(e){return this.low!==e.low?!1:this.high!==e.high?!1:this.lowInclude!==e.lowInclude?!1:this.highInclude!==e.highInclude?!1:!0},n}),define("sequencing/sortedarraybinary",["util/interval"],function(e){"use strict";var t=function(e){var t=parseFloat(e);return e==t&&!isNaN(t)},n=function(e){this.name="SortedArrayError",this.message=e||""};n.prototype=Error.prototype;var r=function(){this.array=[]};return r.prototype.binaryIndexOf=function(e){var t=0,n=this.array.length-1,r,i;while(t<=n){r=(t+n)/2|0,i=this.array[r];if(i<e)t=r+1;else{if(!(i>e))return r;n=r-1}}return~n},r.prototype.insert=function(e){var t=this.binaryIndexOf(e);(t<0||t===0&&this.array[0]!==e)&&this.array.splice(Math.abs(t),0,e)},r.prototype.indexOf=function(e){var t=this.binaryIndexOf(e);return t<0||t===0&&this.array[0]!==e?-1:t},r.prototype.hasElement=function(e){var t=this.binaryIndexOf(e);return t<0||t===0&&this.array[0]!==e?!1:!0},r.prototype.remove=function(e){var t=this.binaryIndexOf(e);if(t<0||t===0&&this.array[0]!==e)return;this.array.splice(t,1)},r.prototype.getMinimum=function(){return this.array.length>0?this.array[0]:null},r.prototype.getMaximum=function(){return this.array.length>0?this.array[this.array.length-1]:null},r.prototype.ltIndexOf=function(e){var t=this.binaryIndexOf(e);return t=t<0?Math.abs(t)-1:t-1,t>=0?t:-1},r.prototype.leIndexOf=function(e){var t=this.binaryIndexOf(e);return t>0||t===0&&this.array[0]===e?t:(t=Math.abs(t)-1,t>=0?t:-1)},r.prototype.gtIndexOf=function(e){var t=this.binaryIndexOf(e);return t===0?this.array[0]===e&&(t=1):t=t<0?Math.abs(t):t+1,t<this.array.length?t:-1},r.prototype.geIndexOf=function(e){var t=this.binaryIndexOf(e);return t>0||t===0&&this.array[0]===e?t:(t=Math.abs(t),t<this.array.length?t:-1)},r.prototype.indexOf=function(e){var t=this.binaryIndexOf(e);return t<0||t===0&&this.array[0]!==e?-1:t},r.prototype.lookup=function(t){t===undefined&&(t=new e(-Infinity,Infinity,!0,!0));if(t instanceof e==0)throw new n("lookup requires Interval argument");var r=-1,i=-1;return t.lowInclude?r=this.geIndexOf(t.low):r=this.gtIndexOf(t.low),r===-1?[]:(t.highInclude?i=this.leIndexOf(t.high):i=this.ltIndexOf(t.high),i===-1?[]:this.array.slice(r,i+1))},r.prototype.get=function(e){return this.array[e]},r.prototype.list=function(){return this.array},r}),define("sequencing/multimap",[],function(){"use strict";var e=function(){this._map={}};return e.prototype.insert=function(e,t){return this.insertAll([{key:e,value:t}])},e.prototype.insertAll=function(e){var t,n=[];return e.forEach(function(e){this._map.hasOwnProperty(e.key)||(this._map[e.key]=[]),t=this._map[e.key],t.indexOf(e.value)===-1&&(t.push(e.value),n.push(e))},this),n},e.prototype.remove=function(e,t){return this.removeAll([{key:e,value:t}])},e.prototype.removeAll=function(e){var t,n,r=[];return e.forEach(function(e){this._map.hasOwnProperty(e.key)&&(n=this._map[e.key],t=n.indexOf(e.value),t>-1&&(n.splice(t,1),r.push(e),n.length===0&&delete this._map[e.key]))},this),r},e.prototype.hasKey=function(e){return this._map.hasOwnProperty(e)},e.prototype.keys=function(){return Object.keys(this._map)},e.prototype.getItemsByKey=function(e){var t=[];return this.hasKey(e)&&this._map[e].forEach(function(n){t.push({key:e,value:n})}),t},e.prototype.getItemsByKeys=function(e){e===undefined&&(e=this.keys());var t=[];return e.forEach(function(e){t=t.concat(this.getItemsByKey(e))},this),t},e.prototype.list=e.prototype.getItemsByKeys,e}),define("sequencing/axis",["util/interval","./sortedarraybinary","./multimap"],function(e,t,n){"use strict";var r=function(e){this.name="AxisError",this.message=e||""};r.prototype=Error.prototype;var i=Object.freeze({NOOP:"noop",CREATE:"create",UPDATE:"update",REMOVE:"remove"}),s=Object.freeze({LOW:"low",SINGULAR:"singular",HIGH:"high",INSIDE:"inside",OUTSIDE:"outside",toInteger:function(e){if(e===s.LOW)return-1;if(e===s.HIGH)return 1;if(e===s.INSIDE)return 2;if(e===s.OUTSIDE)return 3;if(e===s.SINGULAR)return 0;throw new r("illegal string value for point type")},fromInteger:function(e){if(e===-1)return s.LOW;if(e===0)return s.SINGULAR;if(e===1)return s.HIGH;if(e===2)return s.INSIDE;if(e===3)return s.OUTSIDE;throw new r("illegal integer value for point type")}}),o=function(){this._map={},this._reverse=new n,this._index=new t,this._callbacks={change:[]}};return o.prototype._insert=function(e,t){this._map[e]=t,this._reverse.hasKey(t.low)||this._index.insert(t.low),this._reverse.hasKey(t.high)||this._index.insert(t.high),this._reverse.insert(t.low,e),this._reverse.insert(t.high,e)},o.prototype._remove=function(e){if(!this._map.hasOwnProperty(e))throw new r("attempt to remove non-existing key");var t=this._map[e];return delete this._map[e],this._reverse.remove(t.low,e),this._reverse.remove(t.high,e),this._reverse.hasKey(t.low)||this._index.remove(t.low),this._reverse.hasKey(t.high)||this._index.remove(t.high),t},o.prototype.updateAll=function(t){var n,s=[],o,u,a;return t.forEach(function(t){u=t.key,a=t.interval;if(a===undefined)this._map.hasOwnProperty(u)?(o=this._remove(u),n={type:i.REMOVE,key:u,interval:o,data:t.data}):n={type:i.NOOP,key:u,interval:undefined,data:undefined};else{if(a instanceof e==0)throw new r("parameter must be instanceof Interval");this._map.hasOwnProperty(u)?(o=this._map[u],a.equals(o)?n={type:i.NOOP,key:u,interval:o,data:t.data}:(this._remove(u),this._insert(u,a),n={type:i.UPDATE,key:u,interval:a,data:t.data})):(this._insert(u,a),n={type:i.CREATE,key:u,interval:a,data:t.data})}s.push(n)},this),this._doCallbacks("change",s),s},o.prototype.update=function(e,t){return this.updateAll([{key:e,interval:t}])},o.prototype.on=function(e,t,n){if(!t||typeof t!="function")throw new r("Illegal handler");if(!this._callbacks.hasOwnProperty(e))throw new r("Unsupported event "+e);var i=this._callbacks[e].indexOf(t);return i===-1&&(t._ctx_=n||this,this._callbacks[e].push(t)),this},o.prototype.off=function(e,t){if(this._callbacks[e]!==undefined){var n=this._callbacks[e].indexOf(t);n>-1&&this._callbacks[e].splice(n,1)}return this},o.prototype._doCallbacks=function(e,t){var n;this._callbacks[e].forEach(function(n){try{n.call(n._ctx_,t)}catch(r){console.log("Error in "+e+": "+n+": "+r)}},this)},o.prototype.lookupByPoint=function(e){var t,n=[];return Object.keys(this._map).forEach(function(r){t=this._map[r],(e===undefined||t.coversPoint(e))&&n.push({key:r,interval:t})},this),n},o.prototype.lookupByInterval=function(e){var t=this._index.lookup(e),n=[],r,i;return this._index.lookup(e).forEach(function(t){this._reverse.getItemsByKey(t).forEach(function(r){t=r.key,e=this._map[r.value],n.push({key:r.value,interval:e,point:t,pointType:this.getPointType(t,e)})},this)},this),n},o.prototype.items=function(){return this.lookupByPoint()},o.prototype.keys=function(){return Object.keys(this._map)},o.prototype.getPointType=function(e,t){return t.isSingular()&&e===t.low?s.SINGULAR:e===t.low?s.LOW:e===t.high?s.HIGH:t.low<e&&e<t.high?s.INSIDE:s.OUTSIDE},o.prototype.getIntervalByKey=function(e){return this._map[e]},o.prototype.hasKey=function(e){return this._map.hasOwnProperty(e)},{Axis:o,OpType:i,PointType:s}}),define("sequencing/sequencer",["util/motionutils","util/eventutils","util/interval","./axis"],function(e,t,n,r){"use strict";var i=function(e){return e.velocity!==0||e.acceleration!==0},s=function(e,t){var n=[];for(var r=0;r<e.length;r++){var i=!1;for(var s=0;s<t.length;s++)if(e[r]===t[s]){i=!0;break}i||n.push(e[r])}return n},o=Object.freeze({ENTER:"enter",EXIT:"exit",CHANGE:"change",toInteger:function(e){if(e===o.ENTER)return 1;if(e===o.EXIT)return-1;if(e===o.CHANGE)return 0;throw new l("illegal string value verb type "+e)},fromInteger:function(e){if(e===-1)return o.EXIT;if(e===1)return o.ENTER;if(e===0)return o.CHANGE;throw new l("illegal integer value for direction type "+e)}}),u=Object.freeze({BACKWARDS:"backwards",FORWARDS:"forwards",NODIRECTION:"nodirection",toInteger:function(e){if(e===u.BACKWARDS)return-1;if(e===u.FORWARDS)return 1;if(e===u.NODIRECTION)return 0;throw new l("illegal string value direction type "+string)},fromInteger:function(e){if(e===0)return u.NODIRECTION;if(e===-1)return u.BACKWARDS;if(e===1)return u.FORWARDS;throw new l("illegal integer value for direction type"+e+" "+typeof e)}}),a=function(e,t){this.queue=[],this.options=t||{},this.options.lookahead=this.options.lookahead||5,this.timeInterval=new n(e,e+this.options.lookahead,!0,!0),this.posInterval=null};a.prototype.getTimeInterval=function(){return this.timeInterval},a.prototype.getPosInterval=function(){return this.posInterval},a.prototype.setPosInterval=function(e){this.posInterval=e},a.prototype.sortFunc=function(e,t){return e.ts-t.ts},a.prototype.push=function(e,t,n){if(this.timeInterval.coversPoint(t)){var r={ts:t,task:n,push_ts:e};if(t>=e)return this.queue.push(r),this.queue.sort(this.sortFunc),!0;console.log("Schedule : task pushed a bit too late, ts < now ",t-e)}return!1},a.prototype.pop=function(e){var t=[];while(this.queue.length>0&&this.queue[0].ts<=e){var n=this.queue.shift(),r={task:n.task,pop_ts:e,push_ts:n.push_ts,ts:n.ts};t.push(r)}return t},a.prototype.invalidate=function(e){var t,n,r,i=[];for(t=0;t<this.queue.length;t++)r=this.queue[t],r.task.key===e&&i.push(r);for(t=0;t<i.length;t++)r=i[t],n=this.queue.indexOf(r),n>-1&&this.queue.splice(n,1)},a.prototype.advance=function(e){e<this.timeInterval.low&&console.log("Schedule : Advancing backwards "+(e-this.timeInterval.low)),this.queue=[],this.timeInterval=new n(e,e+this.options.lookahead,!1,!0),this.posInterval=null},a.prototype.isExpired=function(e){return e>this.timeInterval.high},a.prototype.getDelayNextTs=function(e){return this.queue.length>0?Math.max(0,this.queue[0].ts-e):Math.max(0,this.timeInterval.high-e)};var f=function(e){this._argOrder=[],this._argMap={},this._sequencer=e};f.prototype.addCue=function(e,t,n){return this._argOrder.push(e),this._argMap[e]={key:e,interval:t,data:n},this},f.prototype.removeCue=function(e,t){return this.addCue(e,undefined,t)},f.prototype.submit=function(){var e=[];return this._argOrder.forEach(function(t){e.push(this._argMap[t])},this),this._argMap={},this._argOrder=[],e.length>0?this._sequencer.updateAll(e):[]};var l=function(e){this.name="SequencerError",this.message=e||""};l.prototype=Error.prototype;var c=function(e,t,n,r,i,s,o,u,a,f){this.src=e,this.key=t,this.interval=n,this.point=i,this.pointType=s,this.dueTs=u,this.delay=o-u,this.directionType=a,this.type=f,this.data=r};c.prototype.toString=function(){var e="["+this.point.toFixed(2)+"]";return e+=" "+this.key,e+=" "+this.interval.toString(),e+=" "+this.type,e+=" "+this.directionType,e+=" "+this.pointType,e+=" delay:"+this.delay.toFixed(4),this.data&&(e+=" "+JSON.stringify(this.data)),e};var h=function(e,t,n){this.key=e,this.interval=t,this.data=n};h.prototype.toString=function(){var e=this.key+" "+this.interval.toString();return this.data&&(e+=" "+JSON.stringify(this.data)),e};var p=function(e,n){this._to=e,this._clock=to.clock,this._axis=n||new r.Axis,this._schedule=null,this._timeout=null,this._activeKeys=[],t.eventify(this,p.prototype),this.eventifyDefineEvent("enter",{init:!0}),this.eventifyDefineEvent("exit"),this.eventifyDefineEvent("change"),this._wrappedOnTimingChange=function(){this._onTimingChange()},this._wrappedOnAxisChange=function(e){this._onAxisChange(e)},this._to.on("change",this._wrappedOnTimingChange,this),this.loadData()};p.prototype.eventifyMakeInitEvents=function(e){return e==="enter"?this._processInitialEvents():[]},p.prototype.loadData=function(){},p.prototype.getData=function(e){},p.prototype._isReady=function(){return this._schedule!==null},p.prototype._onTimingChange=function(t){var o=this._clock.now(),f=this._to.vector;this._isReady()===!1?(this._schedule=new a(o),this._axis.on("change",this._wrappedOnAxisChange,this)):(o=f.timestamp,this._schedule.advance(o));var l=e.calculateVector(f,o),c=this._activeKeys,h=this._axis.lookupByPoint(l.position).map(function(e){return e.key}),p=s(c,h),d=s(h,c),v=i(f);if(v){var m=l.position,g=this._axis.lookupByInterval(new n(m,m,!0,!0));g.forEach(function(t){if(t.pointType===r.PointType.SINGULAR)p.push(t.key);else{var n=t.interval,i=!1;t.pointType===r.PointType.LOW&&n.lowInclude?i=!0:t.pointType===r.PointType.HIGH&&n.highInclude&&(i=!0);var s=u.fromInteger(e.calculateDirection(f,o)),a=!0;t.pointType===r.PointType.LOW&&s===u.BACKWARDS&&(a=!1),t.pointType===r.PointType.HIGH&&s===u.FORWARDS&&(a=!1),!a&&i&&p.push(t.key),a&&!i&&d.push(t.key)}},this)}var y=p.map(function(e){return{key:e,interval:this._axis.getIntervalByKey(e),data:this.getData(e)}},this),b=d.map(function(e){return{key:e,interval:this._axis.getIntervalByKey(e),data:this.getData(e)}},this);this._processIntervalEvents(o,y,b,[]),this._load(o),this._main(o)},p.prototype.updateAll=function(e){this._axis.updateAll(e)},p.prototype._onAxisChange=function(t){var n,s,o,u,a,f=t.filter(function(e){return e.type!==r.OpType.NOOP}),l=this._clock.now(),c=e.calculateVector(this._to.vector,l),h=c.position,p=[],d=[],v,m;f.forEach(function(e){u=e.interval,o=e.key,v=this.isActive(o),m=!1,(e.type===r.OpType.CREATE||e.type===r.OpType.UPDATE)&&u.coversPoint(h)&&(m=!0),e.type===r.OpType.REMOVE?a=e.data:a=e.data||this.getData(o),v&&!m?d.push({key:o,interval:u,data:a}):!v&&m&&p.push({key:o,interval:u,data:a})},this);var g=t.filter(function(e){return this.isActive(e.key)&&p.indexOf(e.key)===-1},this).map(function(e){return{key:e.key,interval:e.interval,data:e.data}},this),y=i(c);if(!y)this._schedule.advance(l);else{f.forEach(function(e){this._schedule.invalidate(e.key)},this);var b,w=[];f.forEach(function(e){u=e.interval,o=e.key;if(e.type===r.OpType.REMOVE)return;if(y){var t={key:o,interval:u},n=this._schedule.getPosInterval();n!==null&&(n.coversPoint(u.low)&&(t.point=u.low),n.coversPoint(u.high)&&(t.point=u.high),t.pointType=this._axis.getPointType(t.point,t.interval),w.push(t))}},this),w.length>0&&this._load(l,w)}var E=this;setTimeout(function(){E._processIntervalEvents(l,d,p,g),E._main(l)},0)},p.prototype._main=function(e){var t;this._timeout!==null&&(this._timeout.cancel(),this._timeout=null),e=e||this._clock.now(),t=this._processScheduleEvents(e,this._schedule.pop(e)),this.eventifyTriggerEvents(t);var n=i(this._to.vector);n&&this._schedule.isExpired(e)&&(e=this._schedule.getTimeInterval().high,this._schedule.advance(e),this._load(e),t=this._processScheduleEvents(e,this._schedule.pop(e)),this.eventifyTriggerEvents(t));if(n){var r=this._clock.now(),s=this._schedule.getDelayNextTs(r),o=this;this._timeout=this._clock.setTimeout(function(){o._main()},s,{anchor:r,early:5e-4})}},p.prototype._load=function(t,s){var o=this._to.vector;if(!i(o))return;var u=this._schedule.getTimeInterval(),a=u.low,f=u.high,l=f-a,c=this._to.range,h=e.calculateVector(o,a),p=s;if(!p){var d=e.calculateInterval(h,l),v=Math.max(d[0],c[0]),m=Math.min(d[1],c[1]),g=new n(v,m,!0,!0);this._schedule.setPosInterval(g),p=this._axis.lookupByInterval(g)}p.forEach(function(e){e.data=this.getData(e.key)},this);var y=e.calculateSolutionsInInterval(h,l,p),b=e.calculateDelta(h,c)[0];y.forEach(function(n){var i=n[0],s=n[1],u=!0;i===0&&(u=!1),i>b&&(u=!1),i===b&&(u=!1);if(s.pointType===r.PointType.LOW||s.pointType===r.PointType.HIGH){var f=e.calculateVector(o,a+i);f.velocity===0&&(u=!1)}u&&this._schedule.push(t,a+i,s)},this)},p.prototype._makeEArgs=function(e,t,n,i,s,a,f,l){var h=u.fromInteger(i),p=this._axis.getPointType(a,t);if(s===undefined){var d=r.PointType.toInteger(p),v=d*i*-1;s=o.fromInteger(v)}return new c(this,e,t,n,a,p,f,l,h,s)},p.prototype._processScheduleEvents=function(t,n){var r,i=[],s=e.calculateVector(this._to.vector,t),u=e.calculateDirection(s,t),a=this._clock.now();return n.forEach(function(e){e.task.interval.isSingular()?(r=this._makeEArgs(e.task.key,e.task.interval,e.task.data,u,o.ENTER,e.task.point,a,e.ts),i.push(r),r=this._makeEArgs(e.task.key,e.task.interval,e.task.data,u,o.EXIT,e.task.point,a,e.ts),i.push(r)):(r=this._makeEArgs(e.task.key,e.task.interval,e.task.data,u,undefined,e.task.point,a,e.ts),i.push(r))},this),this._makeEvents(t,i)},p.prototype._processIntervalEvents=function(t,n,r,i){if(n.length+r.length+i.length===0)return;var s=e.calculateVector(this._to.vector,t),u=e.calculateDirection(s,t),a=this._clock.now(),f=[];n.forEach(function(e){f.push(this._makeEArgs(e.key,e.interval,e.data,u,o.EXIT,s.position,a,t))},this),r.forEach(function(e){f.push(this._makeEArgs(e.key,e.interval,e.data,u,o.ENTER,s.position,a,t))},this),i.forEach(function(e){f.push(this._makeEArgs(e.key,e.interval,e.data,u,o.CHANGE,s.position,a,t))},this),this.eventifyTriggerEvents(this._makeEvents(t,f))},p.prototype._processInitialEvents=function(){var t,n,r,i=this._clock.now(),s=e.calculateVector(this._to.vector,i),u=e.calculateDirection(s,i),a=this._clock.now();return this._activeKeys.map(function(e){return t=this._axis.getIntervalByKey(e),n=this.getData(e),r=this._makeEArgs(e,t,n,u,o.ENTER,s.position,a,i),{type:o.ENTER,e:r}},this)},p.prototype._makeEvents=function(e,t){if(t.length===0)return[];var n,r=[];return t.forEach(function(e){e.type===o.EXIT&&(n=this._activeKeys.indexOf(e.key),n>-1&&this._activeKeys.splice(n,1)),e.type===o.ENTER&&(n=this._activeKeys.indexOf(e.key),n===-1&&this._activeKeys.push(e.key)),r.push(e)},this),r=this._reorderEventList(r),r.map(function(e){return{type:e.type,e:e}})},p.prototype._reorderEventList=function(e){if(e.length<2)return e;var t,n,i=[],s={a:[],x:[],b:[],c:[],y:[],d:[]};return e.forEach(function(e){if(e.point!==t||e.dueTs!==n)i=i.concat(s.a).concat(s.x).concat(s.b).concat(s.c).concat(s.y).concat(s.d),s={a:[],x:[],b:[],c:[],y:[],d:[]},t=e.point,n=e.dueTs;if(e.pointType===r.PointType.SINGULAR)e.type===o.ENTER?s.b.push(e):s.c.push(e);else{var u=!1;e.pointType===r.PointType.LOW&&e.interval.lowInclude?u=!0:e.pointType===r.PointType.HIGH&&e.interval.highInclude&&(u=!0),e.type===o.ENTER?u?s.x.push(e):s.d.push(e):u?s.y.push(e):s.a.push(e)}},this),i.concat(s.a).concat(s.x).concat(s.b).concat(s.c).concat(s.y).concat(s.d)},p.prototype.request=function(){return new f(this)},p.prototype.addCue=function(e,t,n){return this.updateAll([{key:e,interval:t,data:n}])},p.prototype.removeCue=function(e,t){return this.updateAll([{key:e,interval:undefined,data:t}])},p.prototype.hasCue=function(e){return this._axis.hasKey(e)},p.prototype.keys=function(){return this._axis.keys()},p.prototype.getCue=function(e){if(this._axis.hasKey(e))return new h(e,this._axis.getIntervalByKey(e),this.getData(e))},p.prototype.getCues=function(){return this.keys().map(function(e){return this.getCue(e)},this)},p.prototype.isActive=function(e){return this._activeKeys.indexOf(e)>-1},p.prototype.getActiveKeys=function(){var e=[];return this._activeKeys.forEach(function(t){e.push(t)},this),e},p.prototype.getActiveCues=function(){var e=[];return this._activeKeys.forEach(function(t){e.push(this.getCue(t))},this),e},p.prototype.getCuesByPoint=function(e){return this._axis.lookupByPoint(e).map(function(e){return this.getCue(e.key)},this)},p.prototype.getCuesByInterval=function(e){var t={};return this._axis.lookupByInterval(e).forEach(function(e){t[e.key]=e.interval}),Object.keys(t).map(function(e){return this.getCue(e)},this).filter(function(t){return e.overlapsInterval(t.interval)},this)},p.prototype.getCuesCoveredByInterval=function(e){return this.getCuesByInterval(e).filter(function(t){return e.coversInterval(t.interval)?!0:!1},this)},p.prototype.close=function(){this._to.off("change",this._wrappedOnTimingChange,this),this._axis.off("change",this._wrappedOnAxisChange,this),this._timeout!==null&&(this._timeout.cancel(),this._timeout=null)};var d=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.uber=t.prototype,e.prototype.constructor=e};return{inherit:d,Interval:n,Sequencer:p,Axis:r.Axis,SequencerError:l}}),define("sequencing/intervalsequencer",["util/eventutils","util/motionutils","./axis","./sequencer"],function(e,t,n,r){"use strict";var i=function(e,t){var n=[];for(var r=0;r<e.length;r++){var i=!1;for(var s=0;s<t.length;s++)if(e[r]===t[s]){i=!0;break}i||n.push(e[r])}return n},s=r.Interval,o=function(t,i){this._axis=new n.Axis,this._toA=t,this._toB=i,this._seqA=new r.Sequencer(this._toA,this._axis),this._seqB=new r.Sequencer(this._toB,this._axis),this._readyA=!1,this._readyB=!1,this._activeKeys=[],e.eventify(this,o.prototype),this.eventifyDefineEvent("enter",{init:!0}),this.eventifyDefineEvent("exit"),this.eventifyDefineEvent("change"),this._wrappedOnAxisChange=function(e){this._onAxisChange(e)},this._wrappedOnTimingChangeA=function(){this._onTimingChangeA()},this._wrappedOnTimingChangeB=function(){this._onTimingChangeB()},this._wrappedOnSequencerChangeA=function(e){this._onSequencerChangeA(e)},this._wrappedOnSequencerChangeB=function(e){this._onSequencerChangeB(e)},this._toA.on("change",this._wrappedOnTimingChangeA,this),this._toB.on("change",this._wrappedOnTimingChangeB,this),this._seqA.on("events",this._wrappedOnSequencerChangeA,this),this._seqB.on("events",this._wrappedOnSequencerChangeB,this)};return o.prototype._setReadyA=function(){this._readyA||(this._readyA=!0,this._readyB&&this._onReady())},o.prototype._setReadyB=function(){this._readyB||(this._readyB=!0,this._readyA&&this._onReady())},o.prototype._isReady=function(){return this._readyA&&this._readyB},o.prototype._onReady=function(){this._axis.on("change",this._wrappedOnAxisChange,this)},o.prototype._onTimingChangeA=function(){this._setReadyA(),this._reevaluate()},o.prototype._onTimingChangeB=function(){this._setReadyB(),this._reevaluate()},o.prototype._onAxisChange=function(e){this._reevaluate(e)},o.prototype._onSequencerChangeA=function(){this._reevaluate()},o.prototype._onSequencerChangeB=function(){this._reevaluate()},o.prototype.eventifyMakeInitEvents=function(e){return e==="enter"?this._reevaluate():[]},o.prototype._getActiveInterval=function(){var e=this._toA.query(),t=this._toB.query(),n=Math.min(e.position,t.position),r=Math.max(e.position,t.position);return new s(n,r,!0,!0)},o.prototype._getOpFromAxisOpList=function(e,t){var n={};if(e)for(var r=0;r<e.length;r++){var i=e[r];if(i.key===t){n=i;break}}return n},o.prototype._reevaluate=function(e){if(!this._isReady())return[];var t=this._getActiveInterval(),r=this._activeKeys,s=this._seqA.getCuesByInterval(t).map(function(e){return e.key}),o=i(r,s),u=i(s,r),a=[];e&&e.forEach(function(e){r.indexOf(e.key)>-1&&s.indexOf(e.key)>-1&&a.push(e.key)}),this._activeKeys=s;var f=[],l=o.forEach(function(t){var r=this._getOpFromAxisOpList(e,t),i,s;r.type===n.OpType.REMOVE?(i=r.interval,s=r.data):(i=this._axis.getIntervalByKey(t),s=this.getData(t)),f.push({type:"exit",e:{key:t,interval:i,type:"exit",data:s}})},this),c=u.forEach(function(e){f.push({type:"enter",e:{key:e,interval:this._axis.getIntervalByKey(e),type:"enter",data:this.getData(e)}})},this),h=a.forEach(function(e){f.push({type:"change",e:{key:e,interval:this._axis.getIntervalByKey(e),type:"change",data:this.getData(e)}})},this);return this.eventifyTriggerEvents(f),this._activeKeys.map(function(e){return{type:"enter",e:{key:e,interval:this._axis.getIntervalByKey(e),type:"enter"}}},this)},o.prototype.request=function(){return this._seqA.request()},o.prototype.addCue=function(e,t,n){return this._seqA.addCue(e,t,n)},o.prototype.removeCue=function(e,t){return this._seqA.removeCue(e,t)},o.prototype.hasCue=function(e){return this._seqA.hasCue(e)},o.prototype.keys=function(){return this._seqA.keys()},o.prototype.getCue=function(e){return this._seqA.getCue(e)},o.prototype.getCues=function(){return this._seqA.getCues()},o.prototype.isActive=function(e){return this._activeKeys.indexOf(e)>-1},o.prototype.getActiveKeys=function(){var e=[];return this._activeKeys.forEach(function(t){e.push(t)},this),e},o.prototype.getActiveCues=function(){var e=[];return this._activeKeys.forEach(function(t){e.push(this.getCue(t))},this),e},o.prototype.getCuesByPoint=function(e){return this._seqA.getCuesByPoint(e)},o.prototype.getCuesByInterval=function(e){return this._seqA.getCuesByInterval(e)},o.prototype.getCuesCoveredByInterval=function(e){return this._seqA.getCuesCoveredByInterval(e)},o.prototype.close=function(){this._axis.off("change",this._wrappedOnAxisChange),this._toA.off("change",this._wrappedOnTimingChangeA),this._toB.off("change",this._wrappedOnTimingChangeB),this._seqA.off("events",this._wrappedOnSequencerChangeA),this._seqB.off("events",this._wrappedOnSequencerChangeB),this._seqA.close(),this._seqB.close()},o.prototype.loadData=function(){},o.prototype.getData=function(e){},o}),define("sequencing/main",["./sequencer","./intervalsequencer"],function(e,t){"use strict";return{Sequencer:e.Sequencer,Interval:e.Interval,inherit:e.inherit,IntervalSequencer:t}}),define("mediasync/mediasync",[],function(){"use strict";function t(t){if(e===!1)return!1;if(t.canplay)return e=!1,!1;var n=t.muted;return t.muted=!0,t.play(),e=t.paused==1,t.pause(),t.muted=n,e}function n(e,t,n){function c(){l.vel==1&&e.play()}function p(){l.vel==0&&e.pause()}function d(){console.log(err),m()}function A(t){return i.loop?i.duration?t%i.duration:t%e.duration:t}function H(){if(P)return;P=!0,l===undefined&&u(t);if(localStorage&&i.remember&&localStorage.mediascape_vpbr){var n=JSON.parse(localStorage.mediascape_vpbr);n.appVersion===navigator.appVersion&&(S=n.vpbr)}i.mode==="vpbr"&&(S=!0),i.mode==="skip"||S===!1?(e.playbackRate=1,g=D):(i.automute&&(e.muted=!0,s=!0,X("muted",{event:"muted",muted:!0})),g=O),e.removeEventListener("canplay",H),e.removeEventListener("playing",H),j(g)}function J(){if(!i.debug)return;if(typeof i.debug=="function"){var e=arguments;setTimeout(function(){i.debug.apply(window,e)},0)}else{var e=[];for(var t in arguments)e.push(arguments[t]);console.log(JSON.stringify(e))}}var r,i=n||{};i.skew=i.skew||0,i.target=i.target||.025,i.original_target=i.target,i.loop=i.loop||!1,i.target=i.target*2,i.remember===undefined&&(i.remember=!0),i.debug&&(localStorage.removeItem("mediascape_vpbr"),i.remember=!1),i.automute===undefined&&(i.automute=!0);var s=!1,o=function(e){y=0,E=[],C=null;if(a||f)return;g!=undefined?g(e):console.log("WARNING: onchange but no update func yet")},u=function(e){y=0,l&&l.off("change",o),l=e,l.version==3&&(l.__defineGetter__("pos",function(){return l.query().position}),l.__defineGetter__("vel",function(){return l.query().velocity}),l.__defineGetter__("acc",function(){return l.query().acceleration})),l.on("change",o)};t||console.log("WARNING: No motion has been set");var a=!1,f=!1,l,v=function(e){e==undefined&&(e=!0),f=e,f||o()},m=function(){a=!0,e.removeEventListener("paused",c),e.removeEventListener("play",p),e.removeEventListener("error",d)},g,y=0,b=0,w,E=[],S,x=0,T=5,N=!1,C,k=0,L=function(t){if(e.readyState==0)return;if(l.vel!=1){e.currentTime=t,C=undefined,X("skip",{event:"skip",pos:t,target:l.pos,adjust:0});return}var n=0,r=performance.now();if(C){r-C.ts<1500?(k+=1,k>3&&(J("Lost all confidence (thrashing)"),i.target=Math.min(1,i.target*2),X("target_change",{event:"target_change",target:i.target,reason:"thrashing"}),k=0)):k=0;var s=(r-C.ts)/1e3,o=e.currentTime,u=A(C.pos+s)-o;n=C.adjust+u,Math.abs(n)>5&&(n=0)}e.playbackRate=1,J({type:"skip",pos:t+n,target:A(l.pos),adjust:n}),T=Math.min(5,T+5),l.vel!=1?e.currentTime=t:(e.currentTime=t+n,C={ts:r,pos:t,adjust:n}),N&&(N=!1,X("sync",{event:"sync",sync:!1})),X("skip",{event:"skip",pos:t+n,target:l.pos,adjust:n})},O=function(t){if(a||f)return;var n=F();if(A(n.pos)==w)return;w=A(n.pos);var r=A(n.pos+i.skew),o=e.duration;if(o)if(r<0||r>o){e.paused||e.pause();return}n.vel!=0?e.paused&&e.play():e.paused||e.pause();try{if(!S&&y>40)throw s&&(e.muted=!1,s=!1),X("muted",{event:"muted",muted:!1}),new Error("Variable playback rate seems broken - "+y+" bad");var u=r-e.currentTime;if(u<-1||n.vel==0||Math.abs(u)>1){J({type:"jump",diff:u});var c=A(n.pos+i.skew);performance.now()-x>150&&(y+=10,x=performance.now(),L(c));return}E.push(u);if(!(E.length>=3))return;var h=0;for(var p=0;p<E.length;p++)h+=E[p];u=h/E.length,E=E.splice(0,1),J({type:"dbg",diff:u,bad:y,vpbr:S});function d(e,t){return Math.min(l.vel+e,Math.max(l.vel-e,l.vel+t))}Math.abs(u)>1?(E=[],e.playbackRate=d(1,u*1.3),J({type:"vpbr",level:"coarse",rate:e.playbackRate}),y+=20):Math.abs(u)>.5?(E=[],e.playbackRate=d(.5,u*.75),J({type:"vpbr",level:"mid",rate:e.playbackRate}),y+=10):Math.abs(u)>.1?(E=[],e.playbackRate=d(.4,u*.75),J({type:"vpbr",level:"midfine",rate:e.playbackRate}),y+=6):Math.abs(u)>.025?(E=[],e.playbackRate=d(.3,u*.6),J({type:"vpbr",level:"fine",rate:e.playbackRate})):(S||(y=Math.max(0,y-20),b++,b>5&&(S=!0,localStorage&&i.remember&&(J("Variable Playback Rate capability stored"),localStorage.mediascape_vpbr=JSON.stringify({appVersion:navigator.appVersion,vpbr:!0})))),N||(N=!0,X("sync",{event:"sync",sync:!0})),e.playbackRate=d(.02,u*.07)),i.automute&&(!e.muted&&(e.playbackRate>1.05||e.playbackRate<.95)?(s=!0,e.muted=!0,X("muted",{event:"muted",muted:!0}),J({type:"mute",muted:!0})):e.muted&&s&&(s=!1,e.muted=!1,J({type:"mute",muted:!1}),X("muted",{event:"muted",muted:!1})))}catch(v){i.automute&&(e.muted=!1),C=null,localStorage&&i.remember&&(J("Variable Playback Rate NOT SUPPORTED, remembering this  "),localStorage.mediascape_vpbr=JSON.stringify({appVersion:navigator.appVersion,vpbr:!1})),console.log("Error setting variable playback speed - seems broken",v),j(D)}},M,_,D=function(t){if(a||f)return;var n=F();n.vel>0?e.paused&&e.play():e.paused||e.pause();if(n.vel!=1){if(A(n.pos)==M)return;M=n.pos,J("Jump, playback speed is not :",n.vel);var r=A(n.pos+i.skew);e.currentTime!=r&&L(r,"jump");return}var s=n.pos+i.skew,o=s-e.currentTime;if(t!=undefined&&t.pos!=undefined){J("MOTION JUMP");var r=n.pos+i.skew;L(r);return}E.push(o);if(!(E.length>=3))return;var u=0;for(var c=0;c<E.length;c++)u+=E[c];o=u/E.length,E.splice(0,1),Math.abs(o)<.001&&(T=Math.max(5,T)),T<=-2?(J("Lost all confidence"),i.target=Math.min(1,i.target*1.4),T=0,X("target_change",{event:"target_change",target:i.target,reason:"unknown"})):T>15&&(J("Feels better"),i.target==i.original_target&&(N||(N=!0,X("sync",{event:"sync",sync:!0}))),i.target=Math.max(Math.abs(o)*.7,i.original_target),T-=8,X("target_change",{event:"target_change",target:i.target,reason:"improving"})),J({type:"dbg",diff:o,target:i.target,perfect:T});if(Math.abs(o)>i.target){T-=1;if(T>0)return;r=l.pos+i.skew,T+=8,L(r)}else Math.abs(o-_)<i.target/2&&T++,_=o},P=!1;e.addEventListener("canplay",H),e.addEventListener("playing",H);var B,j=function(t){B&&(e.removeEventListener("timeupdate",B),e.removeEventListener("pause",B),e.removeEventListener("ended",B)),B=t,e.playbackRate=1,e.addEventListener("timeupdate",t),e.addEventListener("pause",t),e.addEventListener("ended",t),t===O?X("mode_change",{event:"mode_change",mode:"vpbr"}):X("mode_change",{event:"mode_change",mode:"skip"})},F=function(){if(l.version==3){var e=l.query();return{pos:e.position,vel:e.velocity,acc:e.acceleration}}return l.query()},I=function(e){i.skew=e},q=function(){return i.skew},R=function(e,t){i[e]=t,e==="target"&&(i.original_target=t)},U=function(){return g===O?"playbackRate":"skip"},z=setInterval(function(){if(e.readyState>=2){clearInterval(z);try{var t=new Event("canplay");e.dispatchEvent(t)}catch(n){var t=document.createEvent("Event");t.initEvent("canplay",!0,!1),e.dispatchEvent(t)}}},100),W={skip:[],mode_change:[],target_change:[],muted:[],sync:[]},X=function(e,t){if(!W.hasOwnProperty(e))throw"Unsupported event: "+e;for(var n=0;n<W[e].length;n++){h=W[e][n];try{h.call(r,t)}catch(t){console.log("Error in "+e+": "+h+": "+t)}}},V=function(e,t){if(!W.hasOwnProperty(e))throw"Unknown parameter "+e;var n=W[e].indexOf(t);return n>-1&&W[e].splice(n,1),r},$=function(e,t,n){if(!W.hasOwnProperty(e))throw new Error("Unsupported event: "+e);if(!t||typeof t!="function")throw"Illegal handler";var i=W[e].indexOf(t);if(i!=-1)throw new Error("Already registered");return W[e].push(t),setTimeout(function(){e==="sync"&&X(e,{event:e,sync:N},t),e==="muted"&&X(e,{event:e,muted:s},t)},0),r};return r={setSkew:I,getSkew:q,setOption:R,getMethod:U,setMotion:u,stop:m,pause:v,on:$,off:V},r}var e,r=function(e,t,r){this._sync=n(e,t,r)};return r.prototype.setSkew=function(e){this._sync.setSkew(e)},r.prototype.getSkew=function(){this._sync.getSkew()},r.prototype.setOption=function(e,t){this._sync.setOption(e,t)},r.prototype.getMethod=function(){this._sync.getMethod()},Object.defineProperty(r.prototype,"timingsrc",{get:function(){return this._sync._motion},set:function(e){this._sync.setMotion(e)}}),r.prototype.stop=function(){this._sync.stop()},r.prototype.pause=function(e){this._sync.pause(e)},r.prototype.on=function(e,t,n){this._sync.on(e,t,n)},r.prototype.off=function(e,t){this._sync.off(e,t)},{mediaSync:n,MediaSync:r,mediaNeedKick:t}}),define("timingsrc",["./timingobject/main","./sequencing/main","./mediasync/mediasync"],function(e,t,n){return{inherit:e.inherit,TimingObject:e.TimingObject,ConverterBase:e.ConverterBase,SkewConverter:e.SkewConverter,DelayConverter:e.DelayConverter,ScaleConverter:e.ScaleConverter,LoopConverter:e.LoopConverter,RangeConverter:e.RangeConverter,TimeShiftConverter:e.TimeShiftConverter,LocalConverter:e.LocalConverter,DerivativeConverter:e.DerivativeConverter,Sequencer:t.Sequencer,Interval:t.Interval,IntervalSequencer:t.IntervalSequencer,MediaSync:n.MediaSync,mediaNeedKick:n.needKick}});